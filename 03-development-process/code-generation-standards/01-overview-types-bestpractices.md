# コード生成標準

**バージョン**: 1.0.0  
**最終更新**: 2024-10-24  
**ドキュメント種別**: 開発プロセス標準  
**階層**: Tier 3 (任意)

---

## 概要

### 目的

コード生成標準は、ソフトウェアプロジェクトで自動生成されるコードの作成、保守、管理のためのガイドラインを提供します。このドキュメントは、生成されたコードが保守可能で一貫性があり、プロジェクト標準に従うことを確保するために、コードジェネレーター、テンプレート、開発ワークフローとの統合のベストプラクティスをカバーします。

### コード生成の利点

- **ボイラープレートの削減**: 反復的なコード記述を排除
- **一貫性**: コードベース全体で統一されたパターンを確保
- **生産性**: 共通パターンの開発を高速化
- **保守性**: パターン定義を一元化
- **品質**: 反復的なタスクでの人的エラーを削減
- **標準準拠**: コーディング標準を自動的に強制

---

## コード生成の種類

### スキーマ駆動生成

データスキーマ、API仕様、またはデータベーススキーマからコードを生成。

**一般的な使用例:**
- OpenAPI仕様からのAPIクライアント/サーバーコード
- スキーマからのデータベースモデル
- JSONスキーマからの型定義
- GraphQLリゾルバーと型

**✅ 良い例 - OpenAPI Client Generation:**
```yaml
# openapi.yaml
openapi: 3.0.0
info:
  title: User API
  version: 1.0.0
paths:
  /users:
    get:
      summary: List users
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        200:
          description: List of users
          content:
            application/json:
              schema:
                type: object
                properties:
                  users:
                    type: array
                    items:
                      $ref: '#/components/schemas/User'
                  total:
                    type: integer
components:
  schemas:
    User:
      type: object
      required: [id, email, name]
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        name:
          type: string
          minLength: 1
          maxLength: 100
        createdAt:
          type: string
          format: date-time
```

**Generated TypeScript Client:**
```typescript
// Generated file: src/generated/api-client.ts
// DO NOT EDIT - This file is automatically generated

export interface User {
  id: string;
  email: string;
  name: string;
  createdAt?: string;
}

export interface ListUsersParams {
  limit?: number;
  offset?: number;
}

export interface ListUsersResponse {
  users: User[];
  total: number;
}

export class UserApiClient {
  constructor(private baseUrl: string, private apiKey: string) {}
  
  async listUsers(params: ListUsersParams = {}): Promise<ListUsersResponse> {
    const url = new URL('/users', this.baseUrl);
    
    if (params.limit !== undefined) {
      url.searchParams.set('limit', params.limit.toString());
    }
    if (params.offset !== undefined) {
      url.searchParams.set('offset', params.offset.toString());
    }
    
    const response = await fetch(url.toString(), {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${this.apiKey}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    return response.json();
  }
}
```

**Generation Configuration:**
```json
{
  "generatorName": "typescript-fetch",
  "inputSpec": "openapi.yaml",
  "outputDir": "src/generated",
  "additionalProperties": {
    "typescriptThreePlus": true,
    "supportsES6": true,
    "npmName": "@company/api-client",
    "withoutPrefixEnums": true
  },
  "globalProperties": {
    "generateApiDocumentation": false,
    "generateModelDocumentation": false
  }
}
```

---

### テンプレートベース生成

変数置換を伴うテンプレートを使用したコード生成。

**一般的な使用例:**
- CRUD操作
- コンポーネントの足場
- 設定ファイル
- テストファイル生成

**Example - Entity Generator:**
```handlebars
<!-- templates/entity.hbs -->
import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, UpdateDateColumn } from 'typeorm';

@Entity('{{tableName}}')
export class {{className}} {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  {{#each fields}}
  @Column({{#if this.options}}{{{this.options}}}{{/if}})
  {{this.name}}: {{this.type}};

  {{/each}}
  @CreateDateColumn()
  createdAt: Date;

  @UpdateDateColumn()
  updatedAt: Date;
}
```

**Generator Configuration:**
```yaml
# entity-config.yaml
entities:
  - name: User
    tableName: users
    fields:
      - name: email
        type: string
        options: "{ unique: true }"
      - name: firstName
        type: string
      - name: lastName
        type: string
      - name: isActive
        type: boolean
        options: "{ default: true }"
        
  - name: Post
    tableName: posts
    fields:
      - name: title
        type: string
      - name: content
        type: string
        options: "{ type: 'text' }"
      - name: published
        type: boolean
        options: "{ default: false }"
```

**Generated Output:**
```typescript
// Generated file: src/entities/User.ts
import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, UpdateDateColumn } from 'typeorm';

@Entity('users')
export class User {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ unique: true })
  email: string;

  @Column()
  firstName: string;

  @Column()
  lastName: string;

  @Column({ default: true })
  isActive: boolean;

  @CreateDateColumn()
  createdAt: Date;

  @UpdateDateColumn()
  updatedAt: Date;
}
```

---

### AST（抽象構文木）ベース生成

抽象構文木を構築・操作することによるコード生成。

**一般的な使用例:**
- 複雑なコード変換
- リファクタリングツール
- カスタムlintルール
- コード解析ツール

**Example - TypeScript AST Generation:**
```typescript
import * as ts from 'typescript';

class TypeScriptGenerator {
  generateInterface(name: string, properties: PropertyDefinition[]): ts.InterfaceDeclaration {
    const propertySignatures = properties.map(prop => 
      ts.factory.createPropertySignature(
        undefined, // modifiers
        ts.factory.createIdentifier(prop.name),
        prop.optional ? ts.factory.createToken(ts.SyntaxKind.QuestionToken) : undefined,
        this.createTypeNode(prop.type)
      )
    );

    return ts.factory.createInterfaceDeclaration(
      undefined, // decorators
      [ts.factory.createModifier(ts.SyntaxKind.ExportKeyword)], // modifiers
      ts.factory.createIdentifier(name),
      undefined, // type parameters
      undefined, // heritage clauses
      propertySignatures
    );
  }

  generateSourceFile(interfaces: ts.InterfaceDeclaration[]): string {
    const sourceFile = ts.factory.createSourceFile(
      interfaces,
      ts.factory.createToken(ts.SyntaxKind.EndOfFileToken),
      ts.NodeFlags.None
    );

    const printer = ts.createPrinter({ newLine: ts.NewLineKind.LineFeed });
    return printer.printFile(sourceFile as ts.SourceFile);
  }

  private createTypeNode(type: string): ts.TypeNode {
    switch (type) {
      case 'string':
        return ts.factory.createKeywordTypeNode(ts.SyntaxKind.StringKeyword);
      case 'number':
        return ts.factory.createKeywordTypeNode(ts.SyntaxKind.NumberKeyword);
      case 'boolean':
        return ts.factory.createKeywordTypeNode(ts.SyntaxKind.BooleanKeyword);
      default:
        return ts.factory.createTypeReferenceNode(type);
    }
  }
}

// Usage
const generator = new TypeScriptGenerator();
const userInterface = generator.generateInterface('User', [
  { name: 'id', type: 'string', optional: false },
  { name: 'email', type: 'string', optional: false },
  { name: 'name', type: 'string', optional: true }
]);

const code = generator.generateSourceFile([userInterface]);
console.log(code);
// Output:
// export interface User {
//   id: string;
//   email: string;
//   name?: string;
// }
```

---

## コード生成ベストプラクティス

### 生成されたコードの識別

手動編集を防ぐために、生成されたコードを常に明確にマーク。

**✅ 良い例:**
```typescript
// ==========================================
// Generated file: src/models/User.ts
// DO NOT EDIT - This file is automatically generated
// 
// Generator: entity-generator v2.1.0
// Template: entity.hbs
// Generated at: 2024-10-24T10:30:00Z
// Source: schemas/user.yaml
// ==========================================

import { Entity, PrimaryGeneratedColumn, Column } from 'typeorm';

/**
 * User entity - Generated from schema
 * 
 * @generated
 * @source schemas/user.yaml
 */
@Entity('users')
export class User {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ unique: true })
  email: string;

  @Column()
  name: string;
}

// End of generated file
```

**❌ 悪い例:**
```typescript
// No indication this is generated code
import { Entity, PrimaryGeneratedColumn, Column } from 'typeorm';

@Entity('users')
export class User {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ unique: true })
  email: string;

  @Column()
  name: string;
}
```

---

### テンプレート組織化

```
project/
├── templates/
│   ├── entities/
│   │   ├── entity.hbs          # Main entity template
│   │   ├── repository.hbs      # Repository template
│   │   └── service.hbs         # Service template
│   ├── api/
│   │   ├── controller.hbs      # API controller template
│   │   ├── dto.hbs            # Data transfer object template
│   │   └── routes.hbs         # Route definitions template
│   ├── tests/
│   │   ├── unit-test.hbs      # Unit test template
│   │   └── integration-test.hbs # Integration test template
│   └── shared/
│       ├── header.hbs         # Common file header
│       ├── footer.hbs         # Common file footer
│       └── imports.hbs        # Common imports
├── generators/
│   ├── entity-generator.js    # Entity generation logic
│   ├── api-generator.js       # API generation logic
│   └── test-generator.js      # Test generation logic
└── config/
    ├── generator-config.yaml  # Global generator configuration
    └── templates.json         # Template mappings
```

---

### バージョン管理統合

**Generated Code in Git Strategy:**

```gitignore
# .gitignore

# Option 1: Include generated code (recommended for libraries)
# Include generated files but mark them clearly
# Advantages: Easy to review changes, no build dependencies
src/generated/**/*.ts

# Option 2: Exclude generated code (recommended for applications)
# Exclude generated files and generate during build
# Advantages: Smaller repository, always fresh generation
# src/generated/
# !src/generated/.gitkeep

# Always exclude generator build artifacts
generators/dist/
generators/node_modules/
*.generator.log
```

**Pre-commit Hook for Generated Code:**
```bash
#!/bin/bash
# .git/hooks/pre-commit

echo "Checking generated code consistency..."

# Regenerate code to check for changes
npm run generate:code

# Check if any generated files were modified
if git diff --cached --name-only | grep "src/generated/"; then
  echo "Checking if generated code is up to date..."
  
  # Run generation
  npm run generate:code
  
  # Check if generation created any changes
  if ! git diff --quiet; then
    echo "❌ Generated code is out of date. Please run 'npm run generate:code' and commit the changes."
    exit 1
  fi
  
  echo "✅ Generated code is up to date."
fi

echo "Generated code check complete."
```

---

