# コードレビュー標準
## Code Review Standards

**最終更新日**: 2025-10-23  
**バージョン**: 1.0  
**対象**: 全開発者・レビュアー・Devin AI  

---

## 目次

1. [基本原則](#1-基本原則)
2. [レビュー観点](#2-レビュー観点)
3. [レビュアーの責任](#3-レビュアーの責任)
4. [レビュイーの責任](#4-レビュイーの責任)
5. [レビュープロセス](#5-レビュープロセス)
6. [コメント分類とガイドライン](#6-コメント分類とガイドライン)
7. [レビューチェックリスト](#7-レビューチェックリスト)
8. [レビュー期限とSLA](#8-レビュー期限とsla)
9. [Devin AI向けガイドライン](#9-devin-ai向けガイドライン)

---

## 1. 基本原則

### 1.1 レビューの目的

1. **品質保証**: バグ・脆弱性の早期発見
2. **知識共有**: チーム全体のスキル向上
3. **設計改善**: より良いアーキテクチャの提案
4. **標準遵守**: コーディング規約の徹底
5. **メンタリング**: 若手育成・技術伝承

### 1.2 レビューの心構え

#### **レビュアー**
- 🤝 **建設的**: 批判でなく改善提案
- 🎯 **具体的**: 曖昧でなく明確な指摘
- 📚 **教育的**: 理由を説明し学びを促す
- ⚡ **迅速**: タイムリーなフィードバック
- 🙏 **尊重**: コードではなく問題に焦点

#### **レビュイー**
- 👂 **オープン**: フィードバックを受け入れる姿勢
- 🤔 **質問**: 不明点は積極的に質問
- 💪 **改善**: 指摘を成長の機会と捉える
- 🗣️ **説明**: 設計判断の背景を共有
- 🙏 **感謝**: レビュー時間への感謝

### 1.3 レビューのアンチパターン

❌ **避けるべき行動**:
- 個人攻撃・批判的な表現
- 完璧主義（些細な指摘の乱発）
- 代替案なしの否定
- レビュー放置
- 一方的な押し付け

✅ **推奨される行動**:
- 問題解決にフォーカス
- 重要度の優先順位付け
- 具体的な改善案の提示
- タイムリーなレスポンス
- 対話・議論を促進

---

## 2. レビュー観点

### 2.1 必須レビュー項目

#### **1. 機能性（Functionality）**

**チェックポイント**:
- [ ] 要件を満たしているか
- [ ] ビジネスロジックが正しいか
- [ ] エッジケース・境界値が考慮されているか
- [ ] エラーハンドリングが適切か
- [ ] ユーザビリティが考慮されているか

**質問例**:
- この実装は仕様書の要件X-123を満たしていますか？
- 入力値が空/null/最大値の場合の動作は？
- エラー発生時のユーザーへのフィードバックは適切ですか？

---

#### **2. コード品質（Code Quality）**

**チェックポイント - 保守性メトリクス**:
- [ ] 関数サイズ: 50行以内（理想20行）
- [ ] クラスサイズ: 400行以内（理想200行）
- [ ] 循環的複雑度: 10以下（理想5以下）
- [ ] 認知的複雑度: 15以下（理想5以下）
- [ ] ネスト深さ: 3階層以内（理想2階層）
- [ ] パラメータ数: 5個以内（理想3個）
- [ ] 依存関係数: 10以内（理想5以内）

**チェックポイント - 設計原則**:
- [ ] SOLID原則に準拠
- [ ] DRY原則（重複排除）
- [ ] KISS原則（シンプル性）
- [ ] 適切な抽象化レベル

**質問例**:
- この関数は単一責任原則を満たしていますか？
- 複雑度10を超えていますが、分割できませんか？
- このコードブロックは他の場所と重複していませんか？

---

#### **3. セキュリティ（Security）**

**チェックポイント**:
- [ ] 入力検証が適切か（ホワイトリスト方式）
- [ ] SQLインジェクション対策
- [ ] XSS（クロスサイトスクリプティング）対策
- [ ] 認証・認可が適切か
- [ ] 機密情報のハードコードなし
- [ ] セキュアな暗号化アルゴリズム使用

**質問例**:
- ユーザー入力の検証は十分ですか？
- このクエリはSQLインジェクションに脆弱ではありませんか？
- APIキーがソースコードに含まれていませんか？

---

#### **4. パフォーマンス（Performance）**

**チェックポイント**:
- [ ] アルゴリズム計算量が適切か（O(n²)以下）
- [ ] 不要なループ・ネストなし
- [ ] データベースクエリの最適化（N+1問題等）
- [ ] キャッシュの適切な使用
- [ ] メモリリークの可能性なし

**質問例**:
- このループは毎回DBアクセスしていますが、バッチ取得できませんか？
- このデータはキャッシュ可能ですか？
- この実装で大量データを処理した場合のパフォーマンスは？

---

#### **5. テスト（Testing）**

**チェックポイント**:
- [ ] 単体テストが追加されているか
- [ ] テストカバレッジ80%以上
- [ ] 正常系・異常系・境界値テスト
- [ ] テスト名が明確か（何をテストするか）
- [ ] モック・スタブの適切な使用

**質問例**:
- このビジネスロジックのテストはありますか？
- 異常系（エラーケース）のテストが不足していませんか？
- このテストは何を検証していますか？

---

#### **6. ドキュメンテーション（Documentation）**

**チェックポイント - 必須ドキュメント（Level 1）**:
- [ ] ファイルヘッダーコメント
- [ ] パブリッククラスのドキュメント
- [ ] パブリックAPIのドキュメント
  - パラメータ説明
  - 戻り値説明
  - 例外説明

**チェックポイント - 推奨ドキュメント（Level 2）**:
- [ ] 複雑なロジック（複雑度10以上）のコメント
- [ ] ビジネスルール・制約の説明
- [ ] 非自明な実装の理由説明

**質問例**:
- このクラスの目的・責任が記載されていますか？
- このパブリックメソッドのパラメータ説明はありますか？
- なぜこの実装方法を選択したのか、コメントで説明できますか？

---

#### **7. 命名規則（Naming）**

**チェックポイント**:
- [ ] 変数名・関数名が自己文書化的か
- [ ] ビジネス用語・ドメイン用語を使用
- [ ] 略語より完全形を優先
- [ ] bool値には`is`, `has`, `can`接頭辞
- [ ] マジックナンバーを名前付き定数に

**質問例**:
- 変数名`data`は何を表していますか？より具体的な名前にできませんか？
- `temp`や`tmp`のような曖昧な名前は避けられませんか？

---

#### **8. エラーハンドリング（Error Handling）**

**チェックポイント**:
- [ ] 適切な例外型の使用
- [ ] エラーメッセージが明確か
- [ ] ログ出力が適切か（レベル・内容）
- [ ] リソースのクリーンアップ（finally等）
- [ ] フェイルファスト原則

**質問例**:
- この例外は適切にキャッチされていますか？
- エラー時のユーザーへのメッセージは分かりやすいですか？
- リソース（ファイル、DB接続）は確実にクローズされますか？

---

### 2.2 レビュー優先度

| 優先度 | 分類 | 対応 |
|--------|------|------|
| 🔴 **CRITICAL** | セキュリティ脆弱性、データ損失リスク | マージブロック、即座修正必須 |
| 🟠 **HIGH** | バグ、保守性メトリクス違反 | マージブロック、修正必須 |
| 🟡 **MEDIUM** | 設計改善、パフォーマンス最適化 | 修正推奨、議論の余地あり |
| 🟢 **LOW** | 命名改善、軽微なスタイル | 修正任意、学びの機会 |
| ⚪ **INFO** | 質問、情報共有 | 回答のみ、修正不要 |

---

## 3. レビュアーの責任

### 3.1 レビュー前準備

1. **コンテキスト理解**
   - 関連Issueを確認
   - 設計ドキュメントを確認
   - 既存コードの理解

2. **時間確保**
   - 集中できる時間を確保（30-60分）
   - 中断されない環境

### 3.2 レビュー実施

**Step 1: 全体像の把握（5分）**
- プルリクエストの説明を読む
- 変更ファイル一覧を確認
- 変更規模を把握

**Step 2: 高レベルレビュー（10-15分）**
- アーキテクチャ・設計の妥当性
- 変更の必要性・方向性
- 大きな問題の早期発見

**Step 3: 詳細レビュー（30-45分）**
- コード行ごとの確認
- チェックリスト項目の検証
- コメント・提案の記載

**Step 4: 総合評価（5分）**
- 承認 or 変更要求の判断
- サマリーコメント

### 3.3 コメント記載のベストプラクティス

#### **✅ Good Examples**

**具体的で建設的**:
```
🟡 MEDIUM: この関数は複雑度が15あり、推奨上限の10を超えています。
以下のように分割することを提案します：

1. バリデーション部分を `validateInput()` に抽出
2. ビジネスロジックを `processBusinessLogic()` に抽出
3. レスポンス生成を `buildResponse()` に抽出

参考: 00-general-principles.md の 1.3 コード保守性メトリクス
```

**理由を説明**:
```
🟠 HIGH: `user.password` を直接ログ出力しています。
これはセキュリティリスクです。

理由:
- ログファイルが漏洩した場合、パスワードが露出
- ログは通常平文で保存され、暗号化されていない
- GDPR等のコンプライアンス違反の可能性

提案: `user.id` のみログ出力し、パスワードは除外してください。
```

**代替案を提示**:
```
🟡 MEDIUM: ここで `for` ループを使用していますが、
`.map()` を使うとより簡潔で関数型プログラミングスタイルになります。

// 現在
const results = [];
for (let i = 0; i < items.length; i++) {
  results.push(transform(items[i]));
}

// 提案
const results = items.map(item => transform(item));
```

#### **❌ Bad Examples**

**曖昧で非建設的**:
```
❌ これはダメです。
```

**批判的・攻撃的**:
```
❌ こんな書き方するなんて、基礎がわかってないね。
```

**代替案なし**:
```
❌ この実装は良くない。別の方法で実装してください。
```

### 3.4 承認基準

**承認（Approve）条件**:
- ✅ 全CRITICAL/HIGHコメント対応済み
- ✅ 全チェックリスト項目クリア
- ✅ CI/CD成功
- ✅ マージ可能な品質

**変更要求（Request Changes）条件**:
- ❌ CRITICAL/HIGHコメント未対応
- ❌ 重大なバグ・脆弱性
- ❌ 保守性メトリクス大幅超過

**コメント（Comment）条件**:
- 💬 MEDIUMLOWコメントのみ
- 💬 質問・確認事項
- 💬 学びの共有

---

## 4. レビュイーの責任

### 4.1 プルリクエスト作成前

**セルフレビュー必須項目**:
1. **動作確認**
   - ローカルで全テスト成功
   - 手動テスト完了
   - 想定通りの動作確認

2. **品質チェック**
   - コーディング規約遵守
   - 保守性メトリクス基準内
   - 不要なコード削除（コメントアウト、デバッグコード）

3. **ドキュメント**
   - 必須ドキュメント記載
   - プルリクエスト説明充実
   - 変更理由明記

### 4.2 レビューコメント対応

**対応手順**:
1. **全コメント確認**
   - 優先度順にソート
   - 理解不明なコメントをリストアップ

2. **質問・確認**
   - 不明点は積極的に質問
   - 設計判断の背景を説明
   - 対話を通じて最善策を探る

3. **修正実装**
   - CRITICAL/HIGHは必須対応
   - MEDIUMは可能な限り対応
   - LOWは判断して対応

4. **対応報告**
   - 各コメントに返信
   - 修正内容を説明
   - 対応しない場合は理由説明

### 4.3 対応コメント例

**✅ Good Examples**:
```
修正しました。`validateInput()` に抽出することで、
複雑度が15→8に改善されました。

変更コミット: abc1234
```

```
ご指摘ありがとうございます。
ただ、この実装は以下の理由で現状維持を希望します：

1. パフォーマンス要件（〇〇ms以内）を満たすため
2. 既存の△△モジュールとの整合性維持

代替案として、次のスプリントでリファクタリングする
技術的負債チケット(#789)を作成しました。

いかがでしょうか？
```

**❌ Bad Examples**:
```
❌ 修正しました。  # 何をどう修正したか不明
```

```
❌ それは無理です。  # 理由の説明なし
```

---

## 5. レビュープロセス

### 5.1 標準フロー

```
┌─────────────────┐
│ PR作成          │
│ (レビュイー)    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ レビュー依頼    │
│ (自動通知)      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 初回レビュー    │  ← 24時間以内
│ (レビュアー)    │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
 承認      変更要求
    │         │
    │         ▼
    │    ┌─────────────┐
    │    │ 修正実装    │
    │    │ (レビュイー) │
    │    └──────┬──────┘
    │           │
    │           ▼
    │    ┌─────────────┐
    │    │ 再レビュー  │
    │    │ (レビュアー) │
    │    └──────┬──────┘
    │           │
    └───────────┘
         │
         ▼
    ┌─────────────┐
    │ マージ      │
    └─────────────┘
```

### 5.2 ドラフトPRフロー

**目的**: 早期フィードバック・設計相談

**使用タイミング**:
- 設計方針の確認が必要
- 大規模変更の方向性確認
- 技術的判断の相談

**レビュアーの対応**:
- 高レベルレビューのみ
- アーキテクチャ・設計へのフィードバック
- 詳細なコードレビューは不要

---

## 6. コメント分類とガイドライン

### 6.1 コメントラベル

| ラベル | 意味 | 対応 |
|--------|------|------|
| 🔴 **CRITICAL** | 重大な問題 | 必須修正、マージブロック |
| 🟠 **HIGH** | 重要な問題 | 必須修正、マージブロック |
| 🟡 **MEDIUM** | 改善提案 | 修正推奨、議論可 |
| 🟢 **LOW** | 軽微な改善 | 修正任意 |
| 💡 **SUGGESTION** | 提案・アイデア | 参考情報 |
| ❓ **QUESTION** | 質問・確認 | 回答のみ |
| 👍 **PRAISE** | 良い実装への賞賛 | 回答不要 |
| 📚 **LEARNING** | 学習情報共有 | 回答不要 |

### 6.2 コメントテンプレート

#### **問題指摘**
```
🟠 HIGH: [問題の説明]

理由:
- [なぜ問題か]
- [どのような影響があるか]

提案:
- [具体的な改善案]

参考:
- [関連ドキュメント/規約]
```

#### **質問**
```
❓ QUESTION: [質問内容]

背景:
- [なぜこの質問をするか]
- [自分の理解]

確認したい点:
- [具体的な確認事項]
```

#### **賞賛**
```
👍 PRAISE: この実装は素晴らしいです！

理由:
- [どこが良いか]
- [どのような価値があるか]

学び:
- [他のメンバーへの共有価値]
```

---

## 7. レビューチェックリスト

### 7.1 レビュアー用チェックリスト

#### **機能性**
- [ ] 要件を満たしているか
- [ ] ビジネスロジックが正しいか
- [ ] エッジケース・境界値が考慮されているか

#### **コード品質**
- [ ] 関数サイズ50行以内（複雑な処理は分割）
- [ ] クラスサイズ400行以内
- [ ] 循環的複雑度10以下
- [ ] SOLID原則に準拠
- [ ] DRY原則（重複なし）

#### **セキュリティ**
- [ ] 入力検証が適切
- [ ] SQLインジェクション対策
- [ ] XSS対策
- [ ] 機密情報のハードコードなし

#### **パフォーマンス**
- [ ] アルゴリズム計算量が適切
- [ ] データベースクエリ最適化
- [ ] 不要なループ・ネストなし

#### **テスト**
- [ ] 単体テスト追加
- [ ] テストカバレッジ80%以上
- [ ] 正常系・異常系・境界値テスト

#### **ドキュメント**
- [ ] ファイルヘッダーコメント
- [ ] パブリッククラスのドキュメント
- [ ] パブリックAPIのドキュメント

### 7.2 レビュイー用チェックリスト（セルフレビュー）

**プルリクエスト作成前**:
- [ ] ローカルで全テスト成功
- [ ] コーディング規約遵守
- [ ] 不要なコード削除（コメントアウト、デバッグコード）
- [ ] プルリクエスト説明が充実
- [ ] 最新のベースブランチをマージ済み

**コメント対応時**:
- [ ] 全コメント確認
- [ ] CRITICAL/HIGH対応完了
- [ ] 対応内容をコメントで報告
- [ ] 対応しない場合は理由説明

---

## 8. レビュー期限とSLA

### 8.1 レビュー期限

| プルリクエスト種類 | 初回レビュー | 再レビュー | 最終承認 |
|-------------------|-------------|-----------|---------|
| **通常PR** | 24時間以内 | 12時間以内 | 48時間以内 |
| **緊急PR** | 4時間以内 | 2時間以内 | 8時間以内 |
| **Hotfix** | 1時間以内 | 30分以内 | 2時間以内 |
| **ドラフトPR** | 48時間以内 | - | - |

### 8.2 期限超過時の対応

**レビュアーが対応できない場合**:
1. 他のレビュアーに依頼（Slack等で連絡）
2. プルリクエストコメントで状況説明
3. レビュー完了予定時刻を明示

**レビュイーが対応できない場合**:
1. 対応困難なコメントを明確化
2. ペアプログラミング等で解決
3. 対応完了予定時刻を明示

---

## 9. Devin AI向けガイドライン

### 9.1 レビュー実施時（Devin がレビュアーの場合）

**自動チェック項目**:
1. **保守性メトリクス自動計測**
   - 関数行数、複雑度、ネスト深さを計測
   - 基準超過箇所を検出

2. **コーディング規約チェック**
   - Linter実行結果の確認
   - 命名規則の確認

3. **ドキュメント存在チェック**
   - ファイルヘッダー有無
   - パブリックAPI ドキュメント有無

**コメント生成**:
```python
# 例: 複雑度超過の指摘
if cyclomatic_complexity > 10:
    comment = f"""
🟠 HIGH: この関数の循環的複雑度は{cyclomatic_complexity}で、
推奨上限の10を超えています。

理由:
- 複雑度が高いとテストが困難になります
- バグの混入リスクが増加します
- 保守性が低下します

提案:
以下のように関数を分割することを推奨します：
1. [具体的な分割案を提示]
2. [具体的な分割案を提示]

参考: 00-general-principles.md の 1.3 コード保守性メトリクス
"""
```

### 9.2 レビュー対応時（Devin がレビュイーの場合）

**コメント理解**:
1. 優先度（CRITICAL/HIGH/MEDIUM/LOW）を認識
2. 指摘内容を解析
3. 提案された改善案を理解

**対応実装**:
1. CRITICAL/HIGHは必ず修正
2. MEDIUMは可能な限り修正
3. 修正内容をコミットメッセージに記載

**対応報告**:
```
ご指摘ありがとうございます。以下の通り修正しました。

修正内容:
- `processData()` 関数を3つに分割
  - `validateData()`: 入力検証
  - `transformData()`: データ変換
  - `saveData()`: データ保存

結果:
- 複雑度: 15 → 7に改善
- テストカバレッジ: 85% → 92%に向上

変更コミット: abc1234
```

### 9.3 自動化推奨事項

**CI/CDパイプライン統合**:
```yaml
# 自動レビューチェック
- name: Code Quality Check
  run: |
    # 保守性メトリクス計測
    complexity-check --max-complexity 10
    
    # ドキュメントチェック
    doc-coverage --min-coverage 100 --public-only
    
    # コーディング規約チェック
    eslint src/
    pylint src/
```

---

## 10. トラブルシューティング

### 10.1 レビューが進まない場合

**問題**: レビュアーからのレスポンスがない

**対策**:
1. リマインダーメンション（24時間後）
2. 別のレビュアーに依頼
3. チームリーダーに相談

---

**問題**: レビュアーとレビュイーの意見が対立

**対策**:
1. オンラインミーティングで議論
2. 第三者（アーキテクト等）の意見を求める
3. データ・ベンチマークで客観的判断
4. タイムボックス（議論時間制限）設定

---

**問題**: プルリクエストが大きすぎる

**対策**:
1. 複数のプルリクエストに分割
2. ドラフトPRで早期フィードバック
3. 次回から小さく分割する習慣化

---

## 11. ベストプラクティス

### 11.1 レビュアー

✅ **DO（推奨）**:
- 24時間以内に初回レビュー
- 具体的で建設的なコメント
- 理由と代替案を提示
- 良い実装を賞賛
- 学びを共有

❌ **DON'T（禁止）**:
- レビュー放置
- 批判的・攻撃的な表現
- 完璧主義（些細な指摘乱発）
- 代替案なしの否定
- 一方的な押し付け

### 11.2 レビュイー

✅ **DO（推奨）**:
- セルフレビュー徹底
- 充実したプルリクエスト説明
- タイムリーなコメント対応
- 不明点は積極的に質問
- レビューへの感謝

❌ **DON'T（禁止）**:
- 防御的な態度
- コメント無視
- 大きすぎるプルリクエスト
- セルフレビュー不足
- レビュー依頼前のテスト不足

---

## 改訂履歴

| バージョン | 日付 | 変更内容 | 変更者 |
|-----------|------|----------|--------|
| 1.0 | 2025-10-23 | 初版作成 | システム |

---

**このドキュメントは全開発者・レビュアーが遵守すべき標準です。質の高いコードレビューがチーム全体の成長を促進します。**
