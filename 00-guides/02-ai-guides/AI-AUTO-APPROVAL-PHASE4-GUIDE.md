---
title: "AI Auto-Approval Guide for Phase 4 Review"
version: "1.0.0"
created_date: "2025-11-19"
status: "Active"
owner: "Engineering Leadership Team"
---

# Phase 4 レビューの条件付き自動承認ガイド

> AIが作成したPRを自動承認するための明確な基準と手順

## 📋 ドキュメント情報

| 項目 | 内容 |
|------|------|
| **ドキュメント名** | Phase 4 レビューの条件付き自動承認ガイド |
| **バージョン** | 1.0.0 |
| **最終更新日** | 2025-11-19 |
| **対象読者** | 自律的AIエージェント（Devin、Cursor等） |
| **目的** | リファクタリング・軽微な修正の自動承認により、レビュー待ち時間を削減し、人間は複雑な変更に集中 |

---

## 📖 目次

1. [はじめに](#はじめに)
2. [自動承認の基本原則](#自動承認の基本原則)
3. [自動承認OK条件](#自動承認ok条件)
4. [人間レビュー必須条件](#人間レビュー必須条件)
5. [自動承認時の手順](#自動承認時の手順)
6. [記録とモニタリング](#記録とモニタリング)
7. [品質保証メカニズム](#品質保証メカニズム)

---

## はじめに

### このガイドの目的

Phase 4（レビュー・QA）において、以下を実現します:

✅ **レビュー待ち時間の削減**: 軽微な変更を即座にマージ  
✅ **人間リソースの最適化**: 複雑な変更に人間が集中  
✅ **品質維持**: 自動承認でも品質基準は維持  
✅ **透明性確保**: 全ての自動承認を記録・報告

### 基本方針

```yaml
基本方針:
  safety_first: "品質基準を満たす場合のみ自動承認"
  transparency: "全ての自動承認を記録・報告"
  human_oversight: "事後的な抜き取り確認で品質監視"
  rollback_ready: "問題発生時は即座にロールバック可能"
```

---

## 自動承認の基本原則

### 3つの必要条件

自動承認は以下の**3つのカテゴリ全てを満たす**場合のみ可能:

```
✅ カテゴリA: 品質基準を満たす
    AND
✅ カテゴリB: 変更範囲が限定的
    AND
✅ カテゴリC: リスクが低い
```

1つでも満たさない場合 → **人間レビュー必須**

---

## 自動承認OK条件

### カテゴリA: 品質基準（全て必須）

```yaml
CI/CD品質ゲート:
  - ✅ 全ステップがパス（ビルド、テスト、Linter、セキュリティスキャン）
  - ✅ テストカバレッジ >= 85%
  - ✅ Linter/静的解析エラー 0件
  - ✅ セキュリティスキャン: Critical/High脆弱性 0件
  - ✅ コードレビュー自動チェック全てパス

ドキュメント品質:
  - ✅ PR説明文が標準テンプレートに従っている
  - ✅ 必須セクション7つ全て記載
  - ✅ コードコメント・ドキュメント更新済み
  - ✅ 変更理由・影響範囲が明確
```

---

### カテゴリB: 変更範囲（全て必須）

```yaml
変更量の制限:
  - ✅ 変更ファイル数 <= 5ファイル
  - ✅ 変更行数 <= 200行（追加+削除の合計）
  - ✅ 単一PBIに閉じた変更
  - ✅ 単一モジュール/サービス内で完結

変更内容の制限:
  - ✅ データベース変更なし（スキーマ、マイグレーション、インデックス等）
  - ✅ 外部API変更なし（新規連携、契約変更等）
  - ✅ 認証・認可ロジック変更なし
  - ✅ 決済・課金ロジック変更なし
  - ✅ 設定ファイル変更なし（環境変数、CI/CD設定等）
```

---

### カテゴリC: リスクレベル（全て必須）

```yaml
PBIタイプの制限:
  ✅ 以下のいずれかのみ自動承認可能:
    - REF (Refactoring): リファクタリング
    - BUG (Bug Fix): 軽微なバグ修正
    - NFD (Non-Functional Improvement): 既存機能の非機能改善
  
  ❌ 以下は人間レビュー必須:
    - NPI (New Product/Feature Introduction): 新機能
    - ENH (Enhancement): 機能強化
    - ARC (Architecture Improvement): アーキテクチャ変更
    - HOT (Hotfix): 緊急修正（Phase 4で特別な確認必要）
    - POC (Proof of Concept): 概念実証

セキュリティリスク:
  - ✅ セキュリティ影響なし
  - ✅ 個人情報・機密情報の取り扱い変更なし
  - ✅ 本番データアクセスなし

ビジネスリスク:
  - ✅ ユーザー体験への影響が軽微
  - ✅ SLA/SLOへの影響なし
  - ✅ パフォーマンス影響が軽微（既存の10%以内）
```

---

### 判定フローチャート

```
PR作成
  ↓
[Q1] CI/CD全ステップパスしているか?
  No  → 人間レビュー必須
  Yes → Q2へ
  ↓
[Q2] テストカバレッジ >= 85%か?
  No  → 人間レビュー必須
  Yes → Q3へ
  ↓
[Q3] 変更ファイル数 <= 5 AND 変更行数 <= 200か?
  No  → 人間レビュー必須
  Yes → Q4へ
  ↓
[Q4] PBIタイプが REF/BUG/NFD のいずれかか?
  No  → 人間レビュー必須
  Yes → Q5へ
  ↓
[Q5] DB変更・外部API変更・認証変更がないか?
  変更あり → 人間レビュー必須
  変更なし → Q6へ
  ↓
[Q6] セキュリティリスクがないか?
  リスクあり → 人間レビュー必須
  リスクなし → Q7へ
  ↓
[Q7] PR説明文が標準を満たすか?
  No  → 人間レビュー必須
  Yes → Q8へ
  ↓
[Q8] Phase 2Aで「レビュー要求フラグ」が設定されているか?
  Yes → 人間レビュー必須
  No  → ✅ 自動承認OK
```

---

## 人間レビュー必須条件

以下のいずれかに該当する場合、**必ず人間レビューが必要**:

### カテゴリ1: 変更内容による制限

```yaml
必須人間レビュー:
  - 🔴 NPI、ENH、ARC、HOT、POC のPBIタイプ
  - 🔴 データベース変更（スキーマ、マイグレーション、インデックス）
  - 🔴 外部API変更（新規連携、契約変更、認証方式変更）
  - 🔴 セキュリティ関連の変更
  - 🔴 認証・認可ロジックの変更
  - 🔴 決済・課金ロジックの変更
  - 🔴 設定ファイル変更（環境変数、CI/CD設定、インフラ設定）
```

### カテゴリ2: 品質・リスクによる制限

```yaml
必須人間レビュー:
  - 🔴 CI/CDで1つでもステップが失敗
  - 🔴 テストカバレッジ < 85%
  - 🔴 Linter/静的解析エラーあり
  - 🔴 セキュリティスキャンでCritical/High脆弱性検出
  - 🔴 変更ファイル数 > 5 または 変更行数 > 200
  - 🔴 複数PBI・複数モジュールにまたがる変更
```

### カテゴリ3: プロセスによる制限

```yaml
必須人間レビュー:
  - 🔴 Phase 2Aで「レビュー要求フラグ」が設定されている
  - 🔴 新しいアーキテクチャパターン採用
  - 🔴 複雑なビジネスロジック実装
  - 🔴 パフォーマンス要件が特に厳しい
  - 🔴 PR説明文が標準を満たさない
```

---

## 自動承認時の手順

### Step 1: 条件確認チェックリスト実行

AIは以下のチェックリストを実行:

```markdown
## 自動承認条件チェックリスト

### カテゴリA: 品質基準
- [ ] CI/CD全ステップパス
- [ ] テストカバレッジ >= 85%
- [ ] Linter/静的解析エラー 0件
- [ ] セキュリティスキャン: Critical/High 0件
- [ ] PR説明文が標準を満たす

### カテゴリB: 変更範囲
- [ ] 変更ファイル数 <= 5
- [ ] 変更行数 <= 200
- [ ] 単一PBIに閉じた変更
- [ ] DB変更なし
- [ ] 外部API変更なし
- [ ] 認証・認可変更なし
- [ ] 決済・課金変更なし
- [ ] 設定ファイル変更なし

### カテゴリC: リスクレベル
- [ ] PBIタイプ: REF/BUG/NFD
- [ ] セキュリティリスクなし
- [ ] ユーザー体験への影響が軽微
- [ ] パフォーマンス影響が軽微

### プロセス確認
- [ ] Phase 2Aで「レビュー要求フラグ」なし

### 判定結果
- [ ] 全ての条件を満たす → 自動承認OK
- [ ] 1つでも満たさない → 人間レビュー必須
```

---

### Step 2: 自動承認の実行

全条件を満たす場合:

```yaml
実行手順:
  1. 自動承認ラベルを付与:
     - Label: "auto-approved"
     - Label: "ai-reviewed"
  
  2. 承認コメントを追加:
     """
     🤖 AI自動承認
     
     このPRは自動承認条件を全て満たすため、即座にマージします。
     
     【自動承認理由】
     - PBIタイプ: REF (Refactoring)
     - 変更範囲: 3ファイル、150行
     - CI/CD: 全ステップパス
     - カバレッジ: 88%
     - セキュリティリスク: なし
     
     【確認事項】
     - code-review-standards.md 全項目確認済み
     - テスト実行結果確認済み
     - ドキュメント更新確認済み
     
     Tech Leadへの日次サマリーで報告します。
     """
  
  3. PRをマージ:
     - マージ方法: Squash and Merge（推奨）
     - ブランチ削除: 自動削除
  
  4. 記録を残す:
     - docs/ai-decisions/auto-approved-prs.md に追記
```

---

### Step 3: 事後報告

```yaml
報告タイミング:
  日次サマリー:
    - 対象: Tech Lead
    - 内容: 当日自動承認したPR一覧
    - 形式: Slack通知 + レポートファイル
  
  週次サマリー:
    - 対象: Tech Lead + QA Lead
    - 内容: 週次統計（自動承認数、人間レビュー数、問題発生数）
    - 形式: レポートファイル + レビュー会議

日次サマリーテンプレート:
  """
  📊 AI自動承認 日次サマリー (2025-11-19)
  
  【自動承認PR】
  1. PR #123: ユーザーサービスのリファクタリング (REF)
     - ファイル: 3, 行数: 150, カバレッジ: 88%
  2. PR #124: ログメッセージ改善 (NFD)
     - ファイル: 2, 行数: 50, カバレッジ: 90%
  
  【統計】
  - 自動承認: 2件
  - 人間レビュー待ち: 5件
  - 合計: 7件
  - 自動承認率: 28.6%
  
  【詳細】
  docs/ai-decisions/auto-approved-prs.md
  """
```

---

## 記録とモニタリング

### 記録ファイル

```markdown
## docs/ai-decisions/auto-approved-prs.md

# AI自動承認PR記録

## 2025-11-19

### PR #123: ユーザーサービスのリファクタリング
- **PBI**: PROJ-1234
- **PBIタイプ**: REF
- **マージ日時**: 2025-11-19 10:30:00
- **変更範囲**: 3ファイル、150行
- **テストカバレッジ**: 88%
- **CI/CD結果**: 全ステップパス
- **承認理由**: 全ての自動承認条件を満たす
- **リンク**: https://github.com/org/repo/pull/123

### PR #124: ログメッセージ改善
- **PBI**: PROJ-1235
- **PBIタイプ**: NFD
- **マージ日時**: 2025-11-19 14:15:00
- **変更範囲**: 2ファイル、50行
- **テストカバレッジ**: 90%
- **CI/CD結果**: 全ステップパス
- **承認理由**: 全ての自動承認条件を満たす
- **リンク**: https://github.com/org/repo/pull/124
```

---

### モニタリング指標

```yaml
週次モニタリング:
  自動承認率:
    計算: 自動承認数 / 総PR数
    目標: 20-30%
    アラート: > 50%（過度な自動承認）または < 10%（条件が厳しすぎ）
  
  問題発生率:
    計算: 問題発生PR数 / 自動承認PR数
    目標: < 5%
    アラート: > 10%（自動承認基準の見直し必要）
  
  レビュー待ち時間:
    計算: PR作成からマージまでの平均時間
    目標: 自動承認 < 5分、人間レビュー < 4時間
    アラート: 自動承認 > 30分（システム問題）
```

---

## 品質保証メカニズム

### 抜き取り確認

```yaml
週次抜き取り確認:
  頻度: 毎週金曜日
  担当: Tech Lead
  対象: 当週の自動承認PR全て
  
  確認項目:
    - ✅ 自動承認条件が正しく適用されているか
    - ✅ コード品質が基準を満たしているか
    - ✅ テストが適切か
    - ✅ ドキュメントが適切か
  
  問題発見時:
    1. 該当PRをマーク（要改善）
    2. 必要に応じてリバート
    3. 自動承認基準の見直し
    4. AIへのフィードバック
```

### 問題発生時の対応

```yaml
問題発生時のアクション:
  
  レベル1: 軽微な問題（コメント不足等）:
    - AIへフィードバック
    - 次回から改善
  
  レベル2: 中程度の問題（テスト不足等）:
    - 該当コードの改善PRを作成
    - 自動承認基準の見直し検討
  
  レベル3: 重大な問題（バグ、セキュリティ問題等）:
    - 即座にリバート
    - インシデントレポート作成
    - 自動承認を一時停止
    - 基準の厳格化
  
  レベル4: 本番障害発生:
    - 緊急リバート
    - ポストモーテム実施
    - 自動承認プロセス全体の見直し
```

---

### ロールバック手順

```yaml
ロールバック基準:
  即座にロールバック必須:
    - 本番環境でエラー発生
    - セキュリティ脆弱性発見
    - データ損失リスク発見
  
  検討後ロールバック:
    - パフォーマンス劣化（既存の20%以上）
    - ユーザー体験の悪化
    - 予期しない動作

ロールバック手順:
  1. git revert で該当コミットをリバート
  2. 緊急PR作成・マージ
  3. インシデントレポート作成
  4. 根本原因分析
  5. 再発防止策の実施
```

---

## AIエージェントへの指示

```yaml
ai_guidelines:
  自動承認判断時:
    1. 自動承認条件チェックリストを実行
    2. 全ての条件を満たす場合のみ自動承認
    3. 1つでも満たさない場合は人間レビュー必須
    4. 自動承認時は必ず記録を残す
    5. 日次・週次サマリーで報告
  
  ai_cannot_auto_decide:
    - "✗ 条件を満たさないPRの自動承認"
    - "✗ セキュリティリスクがあるPRの自動承認"
    - "✗ DB変更・外部API変更を伴うPRの自動承認"
    - "✗ NPI/ENH/ARC/HOT/POCタイプのPRの自動承認"
  
  must_do:
    - "✓ チェックリスト全項目を確認"
    - "✓ 自動承認の理由を明記"
    - "✓ 全ての自動承認を記録"
    - "✓ 日次・週次で報告"
    - "✓ 問題発生時は即座に報告"

safety_rules:
  - "疑わしい場合は人間レビューを選択"
  - "セキュリティは最優先"
  - "品質基準は妥協しない"
  - "透明性を確保（全て記録）"
```

---

## 関連ドキュメント

- **phase-4-review-qa-guide.md**: Phase 4全体のガイド
- **code-review-standards.md**: コードレビュー基準
- **testing-strategy.md**: テスト戦略
- **AI-ESCALATION-DECISION-GUIDE.md**: エスカレーション基準

---

## バージョン履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0.0 | 2025-11-19 | 初版作成 |

---

**ドキュメント終了**
