# 脆弱性管理標準

## ドキュメント情報

- **バージョン**: 1.0.0
- **最終更新日**: 2025-10-24
- **ステータス**: アクティブ
- **管理者**: セキュリティチーム
- **カテゴリー**: セキュリティ&コンプライアンス

## 目次

1. [概要](#概要)
2. [脆弱性スキャン](#脆弱性スキャン)
3. [脆弱性評価](#脆弱性評価)
4. [修復プロセス](#修復プロセス)
5. [SLAと優先度](#slaと優先度)
6. [レポートとメトリクス](#レポートとメトリクス)
7. [ツールと自動化](#ツールと自動化)
8. [コンプライアンス要件](#コンプライアンス要件)
9. [Devin AIガイドライン](#devin-aiガイドライン)

---

## 概要

### 目的

本ドキュメントは、すべてのシステム、アプリケーション、インフラストラクチャにおけるセキュリティ脆弱性の識別、評価、優先順位付け、修復の標準を確立します。

### 適用範囲

- **アプリケーションセキュリティ**: Webアプリケーション、API、モバイルアプリ
- **インフラストラクチャセキュリティ**: サーバー、コンテナ、クラウドリソース
- **依存関係管理**: サードパーティライブラリとパッケージ
- **コードセキュリティ**: ソースコードの脆弱性

### 基本原則

1. **継続的スキャン**: 自動化された脆弱性検出
2. **リスクベースの優先順位付け**: 重大な脆弱性を最優先
3. **適時な修復**: 脆弱性修正のための明確なSLA
4. **予防的対策**: セキュリティファーストの開発プラクティス
5. **透明性**: 明確なレポートと追跡

---

## 脆弱性スキャン

### スキャン頻度

#### 本番システム
- **重要システム**: 毎日の自動スキャン
- **高価値システム**: 2日ごと
- **標準システム**: 週次スキャン
- **低リスクシステム**: 月次スキャン

#### 開発環境
- **コミット前**: シークレットスキャン用のGitフック
- **Pull Request**: 自動セキュリティチェック
- **デプロイ前**: リリース前の完全セキュリティスキャン
- **デプロイ後**: デプロイ後の検証スキャン

### スキャンタイプ

#### 1. 静的アプリケーションセキュリティテスト（SAST）
```yaml
# 例: GitHub Actions SAST設定
name: SAST Scan
on: [push, pull_request]

jobs:
  sast:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/security-audit
          
      - name: Run SonarQube
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
```

**ツール**:
- **Semgrep**: パターンベースのコード分析
- **SonarQube**: コード品質とセキュリティ
- **Checkmarx**: エンタープライズSASTソリューション
- **ESLint Security Plugin**: JavaScript専用

**カバレッジ**:
- SQLインジェクション脆弱性
- クロスサイトスクリプティング（XSS）
- 認証/認可の欠陥
- 暗号化の問題
- ハードコードされたシークレット

#### 2. 動的アプリケーションセキュリティテスト（DAST）
```yaml
# 例: OWASP ZAP DAST設定
name: DAST Scan
on:
  schedule:
    - cron: '0 2 * * *'  # 毎日午前2時

jobs:
  dast:
    runs-on: ubuntu-latest
    steps:
      - name: Run OWASP ZAP
        uses: zaproxy/action-baseline@v0.7.0
        with:
          target: 'https://staging.example.com'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
```

**ツール**:
- **OWASP ZAP**: オープンソースWebアプリスキャナ
- **Burp Suite**: プロフェッショナルセキュリティテスト
- **Nikto**: Webサーバースキャナ

**テスト範囲**:
- 実行中のアプリケーション（ステージング/本番）
- APIエンドポイント
- 認証メカニズム
- セッション管理
- 入力検証

#### 3. ソフトウェアコンポジション分析（SCA）
```json
// 例: package.json with audit configuration
{
  "scripts": {
    "audit": "npm audit --audit-level=moderate",
    "audit:fix": "npm audit fix",
    "audit:report": "npm audit --json > audit-report.json"
  },
  "devDependencies": {
    "snyk": "^1.1000.0",
    "retire": "^3.0.0"
  }
}
```

**ツール**:
- **Snyk**: 依存関係の脆弱性スキャン
- **Dependabot**: 自動依存関係更新
- **npm audit / yarn audit**: パッケージマネージャー組み込み
- **OWASP Dependency-Check**: 多言語SCA

**監視対象**:
- 直接依存関係
- 推移的依存関係
- ライセンスコンプライアンス
- 寿命終了（EOL）パッケージ

#### 4. インフラストラクチャスキャン
```yaml
# 例: Trivyコンテナスキャン
name: Container Scan
on: [push]

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Build image
        run: docker build -t myapp:${{ github.sha }} .
        
      - name: Run Trivy scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'myapp:${{ github.sha }}'
          format: 'sarif'
          severity: 'CRITICAL,HIGH'
          output: 'trivy-results.sarif'
```

**ツール**:
- **Trivy**: コンテナとIaCスキャン
- **Clair**: コンテナ脆弱性分析
- **Anchore**: コンテナセキュリティプラットフォーム
- **Checkov**: Infrastructure-as-Codeスキャナ

**範囲**:
- コンテナイメージ
- Kubernetes構成
- クラウドインフラ（AWS、Azure、GCP）
- Infrastructure-as-Code（Terraform、CloudFormation）

#### 5. シークレットスキャン
```yaml
# 例: GitGuardianシークレットスキャン
name: Secret Scan
on: [push, pull_request]

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: GitGuardian scan
        uses: GitGuardian/ggshield-action@master
        env:
          GITHUB_PUSH_BEFORE_SHA: ${{ github.event.before }}
          GITHUB_PUSH_BASE_SHA: ${{ github.event.base }}
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
```

**ツール**:
- **GitGuardian**: コード内のシークレット検出
- **TruffleHog**: Git履歴シークレットスキャナ
- **git-secrets**: シークレット用プレコミットフック

**検出パターン**:
- APIキーとトークン
- データベース認証情報
- 秘密鍵と証明書
- OAuthトークン
- AWSアクセスキー

---

## 脆弱性評価

### CVSSスコアリング

標準化された深刻度評価には **Common Vulnerability Scoring System (CVSS) v3.1** を使用します。

#### CVSSスコア範囲

| スコア範囲 | 深刻度 | カラーコード | 対応レベル |
|-------------|----------|------------|----------------|
| 9.0 - 10.0 | **Critical** | 🔴 赤 | 即時対応 |
| 7.0 - 8.9 | **High** | 🟠 オレンジ | 緊急対応 |
| 4.0 - 6.9 | **Medium** | 🟡 黄 | スケジュール修正 |
| 0.1 - 3.9 | **Low** | 🟢 緑 | 計画的修正 |
| 0.0 | **None** | ⚪ 白 | 情報提供のみ |

#### CVSS考慮メトリクス

**基本メトリクス**:
- **攻撃元区分（AV）**: ネットワーク、隣接、ローカル、物理
- **攻撃条件の複雑さ（AC）**: 低、高
- **必要な特権レベル（PR）**: 不要、低、高
- **利用者の関与（UI）**: 不要、要
- **スコープ（S）**: 変更なし、変更あり
- **影響（C/I/A）**: なし、低、高

**環境メトリクス**:
- **機密性要求度**: 低、中、高
- **完全性要求度**: 低、中、高
- **可用性要求度**: 低、中、高

### リスク優先度マトリクス

CVSSスコアとビジネス影響を組み合わせて実際の優先度を決定：

```
優先度 = CVSS深刻度 × ビジネス影響 × 悪用可能性

ここで:
- CVSS深刻度: Critical=4, High=3, Medium=2, Low=1
- ビジネス影響: Critical=4, High=3, Medium=2, Low=1
- 悪用可能性: 公開Exploit=4, PoC利用可能=3, 理論的=2, なし=1
```

#### ビジネス影響分類

**Critical影響**:
- 決済処理システム
- 認証/認可システム
- 顧客PII（個人識別情報）データアクセス
- コア収益創出機能

**High影響**:
- 顧客向け機能
- 内部ビジネスシステム
- データ分析プラットフォーム
- 管理インターフェース

**Medium影響**:
- 開発ツール
- ステージング環境
- 内部ドキュメント
- 非重要API

**Low影響**:
- レガシーシステム（非推奨）
- テスト環境
- 開発依存関係（非本番）

### 悪用可能性評価

| 要因 | 重み | 説明 |
|--------|--------|-------------|
| **公開Exploit利用可能** | 4x | 実際の攻撃コードが出回っている |
| **実証コード（PoC）** | 3x | デモンストレーションコードが利用可能 |
| **武器化可能** | 2x | 努力すれば悪用可能な脆弱性 |
| **理論的のみ** | 1x | 既知の悪用方法なし |

---

## 修復プロセス

### 修復ワークフロー

```
[脆弱性検出]
         ↓
[自動トリアージ] → チケット作成
         ↓
[セキュリティチームレビュー] → 優先度割り当て
         ↓
[開発チーム割り当て] → 修正実装
         ↓
[コードレビュー] → セキュリティレビュー
         ↓
[テスト] → 脆弱性検証
         ↓
[デプロイ] → 修正リリース
         ↓
[再スキャン] → 修復確認
         ↓
[チケットクローズ] → 解決の文書化
```

### 修復オプション

#### 1. 直接修正（推奨）
- 脆弱な依存関係を更新
- 脆弱なコードにパッチ適用
- セキュリティアップデート適用

**例: 依存関係更新**
```json
// 修正前
{
  "dependencies": {
    "lodash": "4.17.15"  // 脆弱なバージョン
  }
}

// 修正後
{
  "dependencies": {
    "lodash": "4.17.21"  // パッチ適用版
  }
}
```

#### 2. 回避策の実装
直接修正が immediately利用できない場合:
- 入力検証の実装
- レート制限の追加
- アクセス制御の適用
- WAFルールのデプロイ

**例: WAFルール**
```yaml
# SQLインジェクション軽減のためのAWS WAFルール
Name: BlockSQLInjection
Priority: 1
Statement:
  SqliMatchStatement:
    FieldToMatch:
      AllQueryArguments: {}
    TextTransformations:
      - Priority: 0
        Type: URL_DECODE
Action:
  Block: {}
```

#### 3. 補完的統制
修正を待つ間の一時的措置:
- ネットワークセグメンテーション
- 強化された監視
- 追加認証
- トラフィックフィルタリング

#### 4. リスク受容（例外）
**要件**:
- ビジネス正当化の文書化
- セキュリティチーム承認
- 経営幹部承認（Critical/Highの場合）
- 期限付き例外（最大90日）
- 定期的レビュー

**例外テンプレート**:
```markdown
## 脆弱性例外リクエスト

**脆弱性ID**: CVE-XXXX-XXXXX
**CVSSスコア**: X.X (深刻度)
**影響を受けるシステム**: [システム名]

**ビジネス正当化**:
[修正が immediately適用できない理由を説明]

**補完的統制**:
1. [統制1]
2. [統制2]

**例外期間**: [X 日/月]
**レビュー日**: [YYYY-MM-DD]

**承認**:
- セキュリティチーム: [ ]
- エンジニアリングリード: [ ]
- CTO/CISO: [ ]
```

---

## SLAと優先度

### 修復SLA

| 深刻度 | 検出から修正まで | テスト | デプロイ | 合計時間 |
|----------|------------------|---------|------------|------------|
| **Critical** | 24時間 | 4時間 | 2時間 | **1-2日** |
| **High** | 7日 | 1日 | 1日 | **7-10日** |
| **Medium** | 30日 | 3日 | 2日 | **30-35日** |
| **Low** | 90日 | 5日 | 3日 | **90-98日** |

### 緊急対応（Critical脆弱性）

**トリガー条件**:
- CVSSスコア ≥ 9.0
- 公開Exploit利用可能
- 実際の悪用検出
- ゼロデイ脆弱性

**緊急プロセス**:
1. **即時通知**（1時間以内）
   - セキュリティチームアラート
   - エンジニアリングリード通知
   - 経営幹部への情報提供

2. **緊急評価**（2時間以内）
   - 影響分析
   - 影響を受けるシステムの特定
   - 一時的軽減策のデプロイ

3. **迅速な対応**（24時間以内）
   - ホットフィックス開発
   - 緊急コードレビュー
   - 迅速なデプロイ

4. **インシデント後レビュー**（3日以内）
   - 根本原因分析
   - 予防措置
   - ドキュメント更新

### エスカレーションパス

```
レベル1: 開発チーム
  ↓ (SLA超過50%)
レベル2: エンジニアリングリード
  ↓ (SLA超過75%)
レベル3: CTO/CISO
  ↓ (SLA超過100%)
レベル4: 経営幹部チーム
```

---

## レポートとメトリクス

### 脆弱性レポート

#### 日次レポート（自動）
- 新規脆弱性検出（過去24時間）
- Critical/High脆弱性数
- SLA違反
- 修復進捗

#### 週次レポート
- 脆弱性トレンド
- トップ10脆弱性
- チームパフォーマンスメトリクス
- 依存関係健全性スコア

#### 月次レポート（経営幹部向け）
- 全体的なセキュリティ態勢
- 月次トレンド
- リスク削減メトリクス
- コンプライアンスステータス

### 主要メトリクス

#### 1. 平均検出時間（MTTD）
```
MTTD = 脆弱性存在から検出までの時間
目標: Criticalは24時間未満
```

#### 2. 平均修復時間（MTTR）
```
MTTR = 検出から修正デプロイまでの時間
目標: 深刻度別（上記SLA表参照）
```

#### 3. 脆弱性密度
```
脆弱性密度 = 総脆弱性数 / コード行数（1000 LOC当たり）
目標: 1000 LOC当たり0.5未満
```

#### 4. 修復率
```
修復率 = 修正された脆弱性 / 検出された総脆弱性
目標: SLA内で95%以上
```

#### 5. 未解決脆弱性の経過日数
```
平均経過日数 = Σ(未解決日数) / 未解決脆弱性総数
目標: 平均14日未満
```

### ダッシュボード要件

**リアルタイムダッシュボードコンポーネント**:
- 深刻度別現在の脆弱性数
- SLAコンプライアンスステータス
- 最も脆弱なコンポーネント
- 修復速度トレンド
- セキュリティ負債スコア

**例: Grafanaダッシュボードクエリ**
```sql
-- 深刻度別未解決脆弱性
SELECT 
  severity,
  COUNT(*) as count,
  AVG(DATEDIFF(NOW(), detected_date)) as avg_age_days
FROM vulnerabilities
WHERE status = 'OPEN'
GROUP BY severity
ORDER BY 
  CASE severity
    WHEN 'CRITICAL' THEN 1
    WHEN 'HIGH' THEN 2
    WHEN 'MEDIUM' THEN 3
    WHEN 'LOW' THEN 4
  END;
```

---

## ツールと自動化

### 推奨ツールスタック

#### オープンソースツール

| カテゴリー | ツール | 目的 |
|----------|------|---------|
| **SAST** | Semgrep | 高速でカスタマイズ可能な静的分析 |
| **SAST** | SonarQube | コード品質とセキュリティ |
| **DAST** | OWASP ZAP | 動的Webアプリテスト |
| **SCA** | Dependabot | 自動依存関係更新 |
| **Container** | Trivy | コンテナとIaCスキャン |
| **Secret** | TruffleHog | Git履歴シークレット検出 |

#### 商用ツール（オプション）

| カテゴリー | ツール | 目的 |
|----------|------|---------|
| **SAST** | Checkmarx | エンタープライズ静的分析 |
| **SCA** | Snyk | 高度な依存関係管理 |
| **DAST** | Burp Suite Pro | プロフェッショナルWebアプリテスト |
| **Platform** | Veracode | 包括的セキュリティプラットフォーム |

### CI/CD統合

#### GitHub Actionsの例
```yaml
name: Security Pipeline
on: [push, pull_request]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      # シークレットスキャン
      - name: Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          
      # SAST
      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        
      # SCA
      - name: Run Snyk
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          
      # コンテナスキャン
      - name: Build and scan image
        run: |
          docker build -t myapp:${{ github.sha }} .
          trivy image myapp:${{ github.sha }}
          
      # 品質ゲート
      - name: Security Quality Gate
        run: |
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "Critical vulnerabilities found!"
            exit 1
          fi
```

### 自動修復

#### 低リスク問題の自動修正
```yaml
# Dependabot設定
version: 2
updates:
  - package-ecosystem: "npm"
    directory: "/"
    schedule:
      interval: "daily"
    open-pull-requests-limit: 10
    
    # 自動マージルール
    auto-merge:
      - match:
          dependency-type: "development"
          update-type: "semver:patch"
      - match:
          dependency-type: "production"
          update-type: "semver:patch"
          severity: "low"
```

#### 自動テスト
```yaml
# 自動脆弱性検証
name: Verify Fix
on:
  pull_request:
    types: [labeled]

jobs:
  verify:
    if: contains(github.event.pull_request.labels.*.name, 'security-fix')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Re-scan for vulnerability
        run: |
          # 特定の脆弱性チェックを実行
          semgrep --config=$VULNERABILITY_RULE_ID .
          
      - name: Comment result
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '脆弱性検証: 合格 ✅'
            })
```

---

## コンプライアンス要件

### 規制標準

#### OWASP Top 10 (2021)
- A01: アクセス制御の不備
- A02: 暗号化の失敗
- A03: インジェクション
- A04: 安全でない設計
- A05: セキュリティ設定ミス
- A06: 脆弱で古くなったコンポーネント ⭐
- A07: 識別と認証の失敗
- A08: ソフトウェアとデータの完全性の失敗
- A09: セキュリティログとモニタリングの失敗
- A10: サーバー側リクエストフォージェリ（SSRF）

**要件**: すべてのCritical/High OWASP脆弱性はSLA内に修復する必要があります。

#### CWE Top 25
Common Weakness Enumeration（CWE）Top 25の最も危険なソフトウェア脆弱性を監視し優先順位付け。

#### 業界固有のコンプライアンス

**PCI DSS**（決済カード業界）:
- 四半期ごとの脆弱性スキャン
- 年次ペネトレーションテスト
- 高リスク脆弱性の即時修復

**HIPAA**（医療）:
- 定期的なリスク評価
- 脆弱性管理プログラム
- 文書化された修復手順

**SOC 2**（サービス組織）:
- 継続的な脆弱性監視
- 文書化されたセキュリティポリシー
- 定期的なセキュリティテスト

**ISO 27001**（情報セキュリティ）:
- 脆弱性管理プロセス
- リスク対応手順
- 定期的なセキュリティ評価

### 監査証跡要件

**維持すべき文書**:
1. 脆弱性スキャン結果（2年保管）
2. 修復証拠（2年保管）
3. 例外承認（期間＋1年保管）
4. セキュリティ評価（3年保管）
5. ペネトレーションテストレポート（3年保管）

---

## Devin AIガイドライン

### 自動脆弱性検出

**Devinの役割**:
- コードコミット前にセキュリティスキャン実行
- 脆弱な依存関係を特定
- 安全な代替案を提案
- 修復チケットを自動作成

**プレコミットチェック**:
```bash
# Devinはコミット前にこれらを実行すべき
npm audit --audit-level=moderate
semgrep --config=p/security-audit .
git secrets --scan
```

### 脆弱性修復

**Devinの責任**:
1. **影響評価**: 影響を受けるコードパスを分析
2. **修正方法の調査**: パッチ適用版または回避策を見つける
3. **修正実装**: 依存関係の更新またはコードにパッチ適用
4. **徹底的なテスト**: 修正が機能を壊さないことを確認
5. **文書化**: 何を修正したか、なぜ修正したかを説明

**修復ワークフロー**:
```
1. Devinが脆弱性を検出（例: lodash@4.17.15のCVE-2024-XXXXX）
2. Devinが修正版を確認（lodash@4.17.21）
3. Devinがpackage.jsonを更新
4. Devinが互換性確認のためテスト実行
5. Devinがメッセージ付きでコミット: "security: fix CVE-2024-XXXXX by updating lodash to 4.17.21"
6. Devinがセキュリティラベル付きでPR作成
```

### セキュアコーディング支援

**Devinがすべきこと**:
- ✅ セキュアなコーディングパターンを提案
- ✅ 一般的な脆弱性（XSS、SQLインジェクション）について警告
- ✅ 入力検証を推奨
- ✅ 適切なエラーハンドリングを実装
- ✅ パラメータ化クエリを使用
- ✅ 最小権限の原則を適用

**Devinがすべきでないこと**:
- ❌ ハードコードされたシークレットをコミット
- ❌ 非推奨のセキュリティライブラリを使用
- ❌ カスタム暗号化を実装
- ❌ 正当な理由なくセキュリティ機能を無効化
- ❌ セキュリティ警告を無視

### レポート形式

Devinが脆弱性を発見した際のフォーマット:
```markdown
## 🔒 セキュリティ脆弱性レポート

**脆弱性**: CVE-2024-XXXXX
**深刻度**: HIGH (CVSS 7.5)
**コンポーネント**: lodash@4.17.15
**脆弱性タイプ**: プロトタイプ汚染

**影響**:
- リモートコード実行の可能性
- ユーザー入力処理モジュールに影響

**推奨事項**:
lodash@4.17.21以上にアップデート

**修復手順**:
1. 実行: `npm install lodash@4.17.21`
2. 影響を受ける機能をテスト
3. 検証のためステージングにデプロイ

**タイムライン**: 7日以内に修正必須（High深刻度SLA）
```

---

## 付録

### 有用なリソース

- [NIST National Vulnerability Database](https://nvd.nist.gov/)
- [OWASP Vulnerability Management Guide](https://owasp.org/www-community/Vulnerability_Management)
- [CVSS Calculator](https://www.first.org/cvss/calculator/3.1)
- [CWE Top 25](https://cwe.mitre.org/top25/)

### 変更履歴

| バージョン | 日付 | 変更内容 |
|---------|------|---------|
| 1.0.0 | 2025-10-24 | 初版 |

---

**ドキュメント管理者**: セキュリティチーム  
**レビュー頻度**: 四半期ごと  
**次回レビュー**: 2025-01-24
