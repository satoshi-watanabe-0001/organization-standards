# PBI: [バグ内容] - バグ修正

> **テンプレートタイプ**: BUG (Bug Fix)  
> **Phase経路**: (0簡易)→3→4（Phase 2, 5スキップ）  
> **期間目安**: 1-3日

---

## 📋 基本情報

| 項目 | 内容 |
|------|------|
| **PBIタイプ** | BUG - バグ修正 |
| **重大度** | [Critical / High / Medium / Low] |
| **優先度** | [High / Medium / Low] |
| **作成日** | [YYYY-MM-DD] |
| **報告者** | [報告者名] |
| **担当** | [担当者名] |

---

## バグ説明

**概要**: [バグの簡潔な説明]

**発生時刻**: [YYYY-MM-DD HH:MM JST]  
**検知方法**: [例: モニタリングアラート、ユーザー報告、テスト中]  
**環境**: [例: 本番環境、ステージング環境]

---

## 再現手順

1. [ステップ1: 例: ログイン画面でメールアドレス・パスワードを入力]
2. [ステップ2: 例: 「ログイン」ボタンをクリック]
3. [ステップ3: 例: ログイン成功メッセージが表示される]
4. [ステップ4: 例: 3秒後、自動的にログアウトされる]

**再現率**: [例: 100%（毎回再現）、50%（時々再現）]  
**環境条件**: [例: Chrome 120, Windows 11]

---

## 期待される動作

[正しい動作の説明]

例:
```
ログイン後、セッションが24時間維持され、
ユーザーはマイページにアクセスできる。
```

---

## 実際の動作

[現在の誤った動作の説明]

例:
```
ログイン成功メッセージ表示後、3秒で自動ログアウトされ、
再びログイン画面にリダイレクトされる。
```

---

## 影響範囲

### 影響を受けるユーザー
- **ユーザー数**: [例: 全ユーザー（100%）]
- **発生頻度**: [例: 毎回（100%再現）、時々（10%）]
- **影響期間**: [例: 2025-11-15 14:00～現在]

### ビジネスへの影響
- **損失**: [例: ログインできないため、売上損失 約100万円/時間]
- **ブランドイメージ**: [例: カスタマーサポートへの問い合わせ急増（30件/時間）]
- **SLA違反**: [例: 稼働率99.9%の保証違反の可能性]

---

## 原因

### 根本原因
[判明している場合は記載]

例:
```
2025-11-15のデプロイで、セッションCookieのdomain設定が
誤って'localhost'に設定されていた。
本番環境では'example.com'であるべきところ、
環境変数の設定ミスにより固定値'localhost'が使用されていた。
```

### エラーログ
```
[エラーメッセージやスタックトレース]

例:
Error: Invalid API Key
at StripeClient.makeRequest (stripe.ts:45)
```

### コード箇所
```javascript
// 問題のあるコード（authController.ts 45行目）
res.cookie('sessionId', token, {
  domain: 'localhost',  // ← 本番環境で'localhost'が設定されている
  maxAge: 86400000
});

// 正しいコード
res.cookie('sessionId', token, {
  domain: process.env.COOKIE_DOMAIN,  // 環境変数から取得
  maxAge: 86400000
});
```

---

## 修正方針

### 修正内容
- [ ] 修正1: [例: `authController.ts`のCookie domain設定を修正]
- [ ] 修正2: [例: 環境変数`COOKIE_DOMAIN`を使用]
- [ ] 修正3: [例: 単体テスト追加（Cookie設定の検証）]

### 修正の範囲
- **変更ファイル**: [例: `authController.ts`]
- **影響する機能**: [例: ログイン機能のみ]
- **データ移行**: [不要]

---

## 受け入れ基準

### バグ修正確認
- [ ] バグが修正され、期待通りに動作する
- [ ] 再現手順でバグが発生しない
- [ ] ログインセッションが24時間維持される

### 回帰テスト
- [ ] 既存機能に影響がない（回帰テスト）
- [ ] 全ての既存テストが通る

### 再発防止
- [ ] 単体テスト追加（Cookie設定の検証）
- [ ] E2Eテスト追加（ログイン→ページ遷移→ログイン状態維持）
- [ ] CI/CDで自動テスト実行

### ドキュメント
- [ ] バグ報告書作成（根本原因分析）
- [ ] 再発防止策ドキュメント更新

---

## 暫定対応（実施済み）

[すでに実施した応急処置]

例:
```
✅ 2025-11-15 14:30 - メンテナンスモードに変更
✅ 2025-11-15 14:45 - ユーザーに謝罪メッセージ表示
✅ 2025-11-15 15:00 - カスタマーサポートに情報共有
```

---

## ロールバック計画

### ロールバック判断基準
- 修正後も問題が解決しない
- 新たなバグが発生
- パフォーマンスが著しく劣化

### ロールバック手順
1. 前回のデプロイ（2025-11-14）にロールバック
2. データベースの整合性確認
3. モニタリング強化

---

## 再発防止策

### 短期的対策（今回のPBIで実施）
- [ ] Cookie設定の単体テスト追加
- [ ] 環境変数の設定チェックリスト作成

### 中長期的対策（別PBIで対応）
- [ ] デプロイ前のステージング環境での動作確認を必須化
- [ ] 環境変数の自動検証スクリプト作成
- [ ] モニタリングアラートの強化

---

## 見積もり

| 項目 | 内容 |
|------|------|
| **ストーリーポイント** | [例: 2ポイント] |
| **期間** | [例: 2時間～半日] |
| **担当** | バックエンド: [1名] |

---

## チェックリスト（提出前確認）

- [ ] 再現手順が明確
- [ ] 期待動作と実際の動作の違いが明確
- [ ] 影響範囲が定量的に記載
- [ ] 原因が特定されている（または調査中と明記）
- [ ] 修正方針が具体的
- [ ] 再発防止策がある

---

**テンプレートバージョン**: 1.0.0  
**最終更新日**: 2025-11-17
