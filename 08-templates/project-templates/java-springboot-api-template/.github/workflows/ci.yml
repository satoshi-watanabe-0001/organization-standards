name: CI Pipeline

# ãƒˆãƒªã‚¬ãƒ¼: ãƒ—ãƒƒã‚·ãƒ¥ã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«è‡ªå‹•å®Ÿè¡Œ
# organization-standards æº–æ‹ : /08-templates/ci-templates/java-spring-boot/ci.yaml.template
on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'bugfix/**'
      - 'hotfix/**'
  pull_request:
    branches:
      - main
      - develop

# ç’°å¢ƒå¤‰æ•°
env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  # ====================================
  # ãƒ¡ã‚¤ãƒ³ã‚¸ãƒ§ãƒ–: ãƒ“ãƒ«ãƒ‰ã¨ãƒ†ã‚¹ãƒˆï¼ˆorganization-standardsæº–æ‹ ï¼‰
  # å‚ç…§: /08-templates/ci-templates/java-spring-boot/ci.yaml.template
  # ====================================
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è©³ç´°ãªåˆ†æã®ãŸã‚ã®å®Œå…¨ãªå±¥æ­´

      # Java 17ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'gradle'  # Gradleä¾å­˜é–¢ä¿‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥

      # Gradleãƒ©ãƒƒãƒ‘ãƒ¼ã«å®Ÿè¡Œæ¨©é™ä»˜ä¸
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # âœ… å¿…é ˆ: Checkstyleå®Ÿè¡Œï¼ˆã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ãƒã‚§ãƒƒã‚¯ï¼‰
      - name: Run Checkstyle
        run: ./gradlew checkstyleMain checkstyleTest --no-daemon

      # âœ… å¿…é ˆ: Spotless Checkå®Ÿè¡Œï¼ˆã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯ï¼‰
      - name: Run Spotless Check
        run: ./gradlew spotlessCheck --no-daemon

      # âœ… å¿…é ˆ: ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œï¼ˆãƒ†ã‚¹ãƒˆé™¤å¤–ï¼‰
      - name: Build
        run: ./gradlew build -x test --no-daemon

      # âœ… å¿…é ˆ: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      - name: Run Tests
        run: ./gradlew test --no-daemon

      # âœ… å¿…é ˆ: ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤æ¤œè¨¼ï¼ˆæœ€é‡è¦ï¼‰
      - name: Verify Test Coverage
        run: ./gradlew jacocoTestCoverageVerification --no-daemon

      # ğŸŸ¡ æ¨å¥¨: ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      - name: Generate Coverage Report
        if: always()
        run: ./gradlew jacocoTestReport --no-daemon

      # ğŸŸ¡ æ¨å¥¨: ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload Coverage Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: build/reports/jacoco/test/html/

      # ğŸŸ¡ æ¨å¥¨: ãƒ†ã‚¹ãƒˆçµæœã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: build/test-results/test/

      # ğŸŸ¡ æ¨å¥¨: ãƒ“ãƒ«ãƒ‰ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload Build Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: build/libs/

  # ====================================
  # è¿½åŠ ã‚¸ãƒ§ãƒ–: SpotBugsé™çš„è§£æ
  # æ³¨: organization-standardsæ¨™æº–ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ã¯å«ã¾ã‚Œãªã„ãŒã€è¿½åŠ ã®å“è³ªãƒã‚§ãƒƒã‚¯ã¨ã—ã¦æœ‰ç”¨
  # ====================================
  spotbugs:
    name: SpotBugs Analysis
    runs-on: ubuntu-latest
    needs: build
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run SpotBugs
        run: ./gradlew spotbugsMain spotbugsTest --no-daemon
        continue-on-error: false

      - name: Upload SpotBugs reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: spotbugs-reports
          path: build/reports/spotbugs/

  # ====================================
  # è¿½åŠ ã‚¸ãƒ§ãƒ–: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
  # æ³¨: organization-standardsæ¨™æº–ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ã¯å«ã¾ã‚Œãªã„ãŒã€ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºç’°å¢ƒã§ã¯æ¨å¥¨
  # ====================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # OWASP Dependency Checkï¼ˆè„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ï¼‰
      - name: Run OWASP Dependency Check
        run: |
          ./gradlew dependencyCheckAnalyze --no-daemon || true
        continue-on-error: true

      # ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
      - name: Run dependency vulnerability scan
        run: ./gradlew dependencies --no-daemon > dependencies.txt

      - name: Upload dependency list
        uses: actions/upload-artifact@v4
        with:
          name: dependencies
          path: dependencies.txt

  # ====================================
  # è¿½åŠ ã‚¸ãƒ§ãƒ–: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
  # æ³¨: main/developãƒ–ãƒ©ãƒ³ãƒã®ã¿å®Ÿè¡Œ
  # ====================================
  docker-build:
    name: Docker Image Build
    runs-on: ubuntu-latest
    needs: [build, spotbugs]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # JARãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ“ãƒ«ãƒ‰
      - name: Build JAR
        run: ./gradlew bootJar --no-daemon

      # Docker Buildxã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ï¼ˆãƒ—ãƒƒã‚·ãƒ¥ãªã—ï¼‰
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: |
            api-template:${{ github.sha }}
            api-template:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
