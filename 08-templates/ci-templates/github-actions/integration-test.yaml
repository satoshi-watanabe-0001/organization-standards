name: Integration Tests

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  integration-test-java:
    name: çµ±åˆãƒ†ã‚¹ãƒˆ (Java)
    runs-on: ubuntu-latest
    if: hashFiles('**/pom.xml') != '' || hashFiles('**/*.gradle') != ''
    
    services:
      # PostgreSQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: testdb
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      # MySQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆå¿…è¦ã«å¿œã˜ã¦æœ‰åŠ¹åŒ–ï¼‰
      # mysql:
      #   image: mysql:8.0
      #   env:
      #     MYSQL_ROOT_PASSWORD: rootpass
      #     MYSQL_DATABASE: testdb
      #     MYSQL_USER: testuser
      #     MYSQL_PASSWORD: testpass
      #   options: >-
      #     --health-cmd="mysqladmin ping"
      #     --health-interval=10s
      #     --health-timeout=5s
      #     --health-retries=5
      #   ports:
      #     - 3306:3306

      # Redisï¼ˆå¿…è¦ã«å¿œã˜ã¦æœ‰åŠ¹åŒ–ï¼‰
      # redis:
      #   image: redis:7-alpine
      #   options: >-
      #     --health-cmd "redis-cli ping"
      #     --health-interval 10s
      #     --health-timeout 5s
      #     --health-retries 5
      #   ports:
      #     - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # Maven ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
      - name: Run Integration Tests (Maven)
        if: hashFiles('**/pom.xml') != ''
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/testdb
          SPRING_DATASOURCE_USERNAME: testuser
          SPRING_DATASOURCE_PASSWORD: testpass
        run: mvn verify -P integration-test

      # Gradle ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
      - name: Run Integration Tests (Gradle)
        if: hashFiles('**/*.gradle') != ''
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/testdb
          SPRING_DATASOURCE_USERNAME: testuser
          SPRING_DATASOURCE_PASSWORD: testpass
        run: ./gradlew integrationTest

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-report-java
          path: |
            **/target/surefire-reports/
            **/target/failsafe-reports/
            **/build/reports/tests/

  integration-test-testcontainers:
    name: çµ±åˆãƒ†ã‚¹ãƒˆ (TestContainers)
    runs-on: ubuntu-latest
    if: hashFiles('**/pom.xml') != '' || hashFiles('**/*.gradle') != ''
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Maven ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
      - name: Run TestContainers Tests (Maven)
        if: hashFiles('**/pom.xml') != ''
        run: mvn verify -P testcontainers

      # Gradle ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
      - name: Run TestContainers Tests (Gradle)
        if: hashFiles('**/*.gradle') != ''
        run: ./gradlew testcontainersTest

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: testcontainers-report
          path: |
            **/target/surefire-reports/
            **/target/failsafe-reports/
            **/build/reports/tests/

  api-test:
    name: API ãƒ†ã‚¹ãƒˆ (REST Assured)
    runs-on: ubuntu-latest
    if: hashFiles('**/pom.xml') != '' || hashFiles('**/*.gradle') != ''
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: testdb
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ï¼†èµ·å‹•
      - name: Build Application (Maven)
        if: hashFiles('**/pom.xml') != ''
        run: mvn clean package -DskipTests

      - name: Build Application (Gradle)
        if: hashFiles('**/*.gradle') != ''
        run: ./gradlew build -x test

      - name: Start Application
        run: |
          # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§èµ·å‹•
          java -jar target/*.jar &
          # ã¾ãŸã¯
          # java -jar build/libs/*.jar &
          
          # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒèµ·å‹•ã™ã‚‹ã¾ã§å¾…æ©Ÿ
          echo "Waiting for application to start..."
          for i in {1..30}; do
            if curl -f http://localhost:8080/actuator/health; then
              echo "Application is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

      # REST Assured ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      - name: Run API Tests (Maven)
        if: hashFiles('**/pom.xml') != ''
        run: mvn verify -P api-test

      - name: Run API Tests (Gradle)
        if: hashFiles('**/*.gradle') != ''
        run: ./gradlew apiTest

      - name: Upload API Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-report
          path: |
            **/target/surefire-reports/
            **/target/failsafe-reports/
            **/build/reports/tests/

  integration-test-nodejs:
    name: çµ±åˆãƒ†ã‚¹ãƒˆ (Node.js)
    runs-on: ubuntu-latest
    if: hashFiles('**/package.json') != ''
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: testdb
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run Integration Tests
        env:
          DATABASE_URL: postgresql://testuser:testpass@localhost:5432/testdb
          NODE_ENV: test
        run: npm run test:integration

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-report-nodejs
          path: |
            coverage/
            test-results/

  integration-test-python:
    name: çµ±åˆãƒ†ã‚¹ãƒˆ (Python)
    runs-on: ubuntu-latest
    if: hashFiles('**/requirements.txt') != '' || hashFiles('**/pyproject.toml') != ''
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: testdb
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio

      - name: Run Integration Tests
        env:
          DATABASE_URL: postgresql://testuser:testpass@localhost:5432/testdb
          ENVIRONMENT: test
        run: pytest tests/integration/ --cov=. --cov-report=xml

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-report-python
          path: |
            coverage.xml
            htmlcov/

  integration-summary:
    name: çµ±åˆãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼
    runs-on: ubuntu-latest
    needs: [integration-test-java, integration-test-testcontainers, api-test, integration-test-nodejs, integration-test-python]
    if: always()
    
    steps:
      - name: Create Summary
        uses: actions/github-script@v7
        with:
          script: |
            const javaResult = '${{ needs.integration-test-java.result }}';
            const testcontainersResult = '${{ needs.integration-test-testcontainers.result }}';
            const apiTestResult = '${{ needs.api-test.result }}';
            const nodejsResult = '${{ needs.integration-test-nodejs.result }}';
            const pythonResult = '${{ needs.integration-test-python.result }}';
            
            let summary = '# ğŸ§ª çµ±åˆãƒ†ã‚¹ãƒˆçµæœ\n\n';
            summary += '| ãƒ†ã‚¹ãƒˆç¨®åˆ¥ | çµæœ |\n';
            summary += '|-----------|------|\n';
            
            if (javaResult !== 'skipped') {
              summary += `| Javaçµ±åˆãƒ†ã‚¹ãƒˆ | ${javaResult === 'success' ? 'âœ… åˆæ ¼' : 'âŒ å¤±æ•—'} |\n`;
            }
            if (testcontainersResult !== 'skipped') {
              summary += `| TestContainers | ${testcontainersResult === 'success' ? 'âœ… åˆæ ¼' : 'âŒ å¤±æ•—'} |\n`;
            }
            if (apiTestResult !== 'skipped') {
              summary += `| APIãƒ†ã‚¹ãƒˆ | ${apiTestResult === 'success' ? 'âœ… åˆæ ¼' : 'âŒ å¤±æ•—'} |\n`;
            }
            if (nodejsResult !== 'skipped') {
              summary += `| Node.jsçµ±åˆãƒ†ã‚¹ãƒˆ | ${nodejsResult === 'success' ? 'âœ… åˆæ ¼' : 'âŒ å¤±æ•—'} |\n`;
            }
            if (pythonResult !== 'skipped') {
              summary += `| Pythonçµ±åˆãƒ†ã‚¹ãƒˆ | ${pythonResult === 'success' ? 'âœ… åˆæ ¼' : 'âŒ å¤±æ•—'} |\n`;
            }
            
            summary += '\n';
            
            const allSuccess = [javaResult, testcontainersResult, apiTestResult, nodejsResult, pythonResult]
              .filter(r => r !== 'skipped')
              .every(r => r === 'success');
            
            if (allSuccess) {
              summary += 'âœ… **ã™ã¹ã¦ã®çµ±åˆãƒ†ã‚¹ãƒˆãŒåˆæ ¼ã—ã¾ã—ãŸï¼**\n';
            } else {
              summary += 'âš ï¸ **ä¸€éƒ¨ã®çµ±åˆãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚**\n';
            }
            
            core.summary.addRaw(summary);
            await core.summary.write();

      - name: Comment on PR (å¤±æ•—æ™‚)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ”´ çµ±åˆãƒ†ã‚¹ãƒˆå¤±æ•—

            **çµ±åˆãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸï¼**

            ### ç¢ºèªæ–¹æ³•
            1. GitHub Actions ã® "Artifacts" ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰è©²å½“ã™ã‚‹ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            2. ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ã€å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ç‰¹å®š
            3. ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§å†ç¾ã—ã¦ãƒ‡ãƒãƒƒã‚°

            ### ã‚ˆãã‚ã‚‹å¤±æ•—åŸå› 

            #### 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼
            - **åŸå› **: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸåŒ–ã«å¤±æ•—
            - **å¯¾å‡¦**: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚„ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª

            #### 2. API ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ä¸ä¸€è‡´
            - **åŸå› **: æœŸå¾…å€¤ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒç•°ãªã‚‹
            - **å¯¾å‡¦**: APIä»•æ§˜ã¨ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®æ•´åˆæ€§ã‚’ç¢ºèª

            #### 3. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼
            - **åŸå› **: å‡¦ç†æ™‚é–“ãŒé•·ã™ãã‚‹
            - **å¯¾å‡¦**: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå€¤ã®èª¿æ•´ã€ã¾ãŸã¯å‡¦ç†ã®æœ€é©åŒ–

            #### 4. ä¾å­˜ã‚µãƒ¼ãƒ“ã‚¹ã®èµ·å‹•å¤±æ•—
            - **åŸå› **: Docker ã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•ã«å¤±æ•—
            - **å¯¾å‡¦**: ã‚µãƒ¼ãƒ“ã‚¹å®šç¾©ï¼ˆservices:ï¼‰ã‚’ç¢ºèª

            ### ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®å†ç¾æ–¹æ³•

            \`\`\`bash
            # Docker Compose ã§ä¾å­˜ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•
            docker-compose up -d

            # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
            # Maven
            mvn verify -P integration-test

            # Gradle
            ./gradlew integrationTest

            # Node.js
            npm run test:integration

            # Python
            pytest tests/integration/
            \`\`\`

            ### å‚è€ƒè³‡æ–™
            - [TestContainers Documentation](https://www.testcontainers.org/)
            - [REST Assured Documentation](https://rest-assured.io/)
            `
            })
