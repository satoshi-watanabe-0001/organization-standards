name: Security Scan

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ 9:00 (JST) ã«å®Ÿè¡Œ
    - cron: '0 0 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  dependency-check:
    name: ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        id: depcheck
        with:
          project: ${{ github.repository }}
          path: '.'
          format: 'HTML'
          args: >
            --enableRetired
            --failOnCVSS 7
            --suppression dependency-check-suppressions.xml

      - name: Upload Dependency-Check Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: ${{ github.workspace }}/reports

      - name: Comment on PR (è„†å¼±æ€§æ¤œå‡ºæ™‚)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ”´ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—

            **ä¾å­˜é–¢ä¿‚ã«è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼**

            ### ç¢ºèªæ–¹æ³•
            1. GitHub Actions ã® "Artifacts" ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ \`dependency-check-report\` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            2. ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ã€æ¤œå‡ºã•ã‚ŒãŸè„†å¼±æ€§ã‚’ç‰¹å®š
            3. ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®æ–¹æ³•ã§å¯¾å‡¦ã—ã¦ãã ã•ã„ï¼š

            ### å¯¾å‡¦æ–¹æ³•

            #### æ–¹æ³•1: ä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°ï¼ˆæ¨å¥¨ï¼‰
            \`\`\`bash
            # è„†å¼±æ€§ã®ã‚ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æœ€æ–°ç‰ˆã«æ›´æ–°
            # Maven ã®å ´åˆ
            mvn versions:use-latest-releases

            # Gradle ã®å ´åˆ
            ./gradlew dependencyUpdates

            # npm ã®å ´åˆ
            npm audit fix

            # pip ã®å ´åˆ
            pip install --upgrade <package-name>
            \`\`\`

            #### æ–¹æ³•2: èª¤æ¤œå‡ºã®å ´åˆï¼ˆæŠ‘åˆ¶ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ï¼‰
            ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã« \`dependency-check-suppressions.xml\` ã‚’ä½œæˆï¼š
            \`\`\`xml
            <?xml version="1.0" encoding="UTF-8"?>
            <suppressions xmlns="https://jeremylong.github.io/DependencyCheck/dependency-suppression.1.3.xsd">
              <suppress>
                <notes>ç†ç”±ã‚’è¨˜è¼‰</notes>
                <cve>CVE-2023-XXXXX</cve>
              </suppress>
            </suppressions>
            \`\`\`

            ### å‚è€ƒè³‡æ–™
            - [OWASP Dependency-Check Documentation](https://jeremylong.github.io/DependencyCheck/)
            - [National Vulnerability Database](https://nvd.nist.gov/)
            `
            })

  secret-scan:
    name: ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      - name: Comment on PR (ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡ºæ™‚)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ”´ ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³å¤±æ•—

            **ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸèªè¨¼æƒ…å ±ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼**

            ### ç·Šæ€¥å¯¾å¿œãŒå¿…è¦ã§ã™

            æ¤œå‡ºã•ã‚ŒãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¯ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼š
            - API ã‚­ãƒ¼
            - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
            - ãƒˆãƒ¼ã‚¯ãƒ³
            - ç§˜å¯†éµ
            - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæ–‡å­—åˆ—

            ### å¯¾å‡¦æ‰‹é †

            #### Step 1: å³åº§ã«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ç„¡åŠ¹åŒ–
            \`\`\`bash
            # æ¤œå‡ºã•ã‚ŒãŸAPIã‚­ãƒ¼/ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç›´ã¡ã«ç„¡åŠ¹åŒ–ã—ã¦ãã ã•ã„
            # ä¾‹: GitHub Personal Access Token
            # â†’ GitHub Settings â†’ Developer settings â†’ Personal access tokens â†’ è©²å½“ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤
            \`\`\`

            #### Step 2: Gitã®å±¥æ­´ã‹ã‚‰å‰Šé™¤
            \`\`\`bash
            # BFG Repo-Cleaner ã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰
            java -jar bfg.jar --replace-text passwords.txt <repo>

            # ã¾ãŸã¯ git filter-branch
            git filter-branch --force --index-filter \\
              'git rm --cached --ignore-unmatch <ãƒ•ã‚¡ã‚¤ãƒ«>' \\
              --prune-empty --tag-name-filter cat -- --all

            # å¼·åˆ¶ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆæ³¨æ„: ãƒãƒ¼ãƒ å…¨å“¡ã¸ã®é€šçŸ¥ãŒå¿…è¦ï¼‰
            git push origin --force --all
            \`\`\`

            #### Step 3: ç’°å¢ƒå¤‰æ•°/ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†ã«ç§»è¡Œ
            \`\`\`bash
            # GitHub Secrets ã«ç™»éŒ²
            # Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret

            # ã‚³ãƒ¼ãƒ‰å†…ã§ã®ä½¿ç”¨ä¾‹
            # \${{ secrets.API_KEY }}
            \`\`\`

            #### Step 4: .gitignore ã«è¿½åŠ 
            \`\`\`bash
            # .gitignore ã«è¿½åŠ ã—ã¦ä»Šå¾Œã®æ¼æ´©ã‚’é˜²æ­¢
            echo ".env" >> .gitignore
            echo "*.key" >> .gitignore
            echo "*.pem" >> .gitignore
            \`\`\`

            ### å‚è€ƒè³‡æ–™
            - [GitHub Secrets Management](https://docs.github.com/en/actions/security-guides/encrypted-secrets)
            - [BFG Repo-Cleaner](https://rtyley.github.io/bfg-repo-cleaner/)
            `
            })

  security-summary:
    name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚µãƒãƒªãƒ¼
    runs-on: ubuntu-latest
    needs: [dependency-check, secret-scan]
    if: always()
    
    steps:
      - name: Create Summary
        uses: actions/github-script@v7
        with:
          script: |
            const depCheckResult = '${{ needs.dependency-check.result }}';
            const secretScanResult = '${{ needs.secret-scan.result }}';
            
            let summary = '# ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœ\n\n';
            
            // ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
            summary += '## ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³\n';
            if (depCheckResult === 'success') {
              summary += 'âœ… **åˆæ ¼**: è„†å¼±æ€§ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ\n\n';
            } else {
              summary += 'âŒ **å¤±æ•—**: è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ\n\n';
            }
            
            // ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³
            summary += '## ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³\n';
            if (secretScanResult === 'success') {
              summary += 'âœ… **åˆæ ¼**: ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸèªè¨¼æƒ…å ±ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ\n\n';
            } else {
              summary += 'âŒ **å¤±æ•—**: ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸèªè¨¼æƒ…å ±ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ\n\n';
            }
            
            // ç·åˆåˆ¤å®š
            summary += '## ç·åˆåˆ¤å®š\n';
            if (depCheckResult === 'success' && secretScanResult === 'success') {
              summary += 'âœ… **ã™ã¹ã¦ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ãŒåˆæ ¼ã—ã¾ã—ãŸ**\n\n';
            } else {
              summary += 'âŒ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä¸Šè¨˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèªã—ã¦å¯¾å‡¦ã—ã¦ãã ã•ã„ã€‚**\n\n';
            }
            
            core.summary.addRaw(summary);
            await core.summary.write();

      - name: Comment on PR (ã‚µãƒãƒªãƒ¼)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const depCheckResult = '${{ needs.dependency-check.result }}';
            const secretScanResult = '${{ needs.secret-scan.result }}';
            
            let body = '## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœ\n\n';
            body += '| ã‚¹ã‚­ãƒ£ãƒ³é …ç›® | çµæœ |\n';
            body += '|------------|------|\n';
            body += `| ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ | ${depCheckResult === 'success' ? 'âœ… åˆæ ¼' : 'âŒ å¤±æ•—'} |\n`;
            body += `| ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ | ${secretScanResult === 'success' ? 'âœ… åˆæ ¼' : 'âŒ å¤±æ•—'} |\n\n`;
            
            if (depCheckResult === 'success' && secretScanResult === 'success') {
              body += 'âœ… **ã™ã¹ã¦ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ãŒåˆæ ¼ã—ã¾ã—ãŸï¼**\n';
            } else {
              body += 'âš ï¸ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ã¯ä¸Šè¨˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚**\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })
