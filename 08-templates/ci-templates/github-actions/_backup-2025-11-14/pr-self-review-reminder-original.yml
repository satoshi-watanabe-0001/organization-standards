name: PR Self-Review Reminder

on:
  pull_request:
    types: [opened, synchronize]  # åˆå›æŠ•ç¨¿æ™‚ + ã‚³ãƒŸãƒƒãƒˆè¿½åŠ æ™‚

# GitHub API å‘¼ã³å‡ºã—ã«å¿…è¦ãªæ¨©é™
permissions:
  contents: read           # ãƒªãƒã‚¸ãƒˆãƒªã®èª­ã¿å–ã‚Š
  pull-requests: write     # PRã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆã€ãƒ©ãƒ™ãƒ«æ“ä½œ
  issues: write            # Issueã‚³ãƒ¡ãƒ³ãƒˆã€ãƒ©ãƒ™ãƒ«æ“ä½œï¼ˆPRã‚‚Issueã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹ï¼‰

jobs:
  remind-checklist:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Checklist Confirmation
        id: check_checklist
        uses: actions/github-script@v7
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            // ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆãŒæ—¢ã«ã‚ã‚‹ã‹ç¢ºèª
            const hasReminder = comments.data.some(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’æ­£ã—ãé¸å®šã—ã€ç¢ºèªã—ã¦ã„ã¾ã™ã‹')
            );
            
            // ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç¢ºèªå®Œäº†ã®ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹ã‹ç¢ºèª
            const hasChecklistConfirmation = comments.data.some(comment => {
              const body = comment.body.toLowerCase();
              return (
                // ç¢ºèªå®Œäº†ã®æ˜ç¤ºçš„ãªè¡¨ç¾
                body.includes('ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ') && (
                  body.includes('ç¢ºèªå®Œäº†') ||
                  body.includes('ç¢ºèªã—ã¾ã—ãŸ') ||
                  body.includes('ãƒã‚§ãƒƒã‚¯å®Œäº†') ||
                  body.includes('ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†') ||
                  body.includes('ã‚»ãƒ«ãƒ•ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†')
                ) ||
                // ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã®ç¨®é¡ã‚’æ˜ç¤º
                (body.includes('ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ') && (
                  body.includes('ä½¿ç”¨ã—ã¾ã—ãŸ') ||
                  body.includes('ã«æ²¿ã£ã¦ç¢ºèª') ||
                  body.includes('ã‚’ç¢ºèª')
                ))
              );
            });
            
            // PRæœ¬æ–‡ã«ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç¢ºèªã®è¨˜è¼‰ãŒã‚ã‚‹ã‹ç¢ºèª
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const prBody = (pr.data.body || '').toLowerCase();
            const hasChecklistInPR = (
              (prBody.includes('ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ') && (
                prBody.includes('ç¢ºèªå®Œäº†') ||
                prBody.includes('ç¢ºèªã—ã¾ã—ãŸ') ||
                prBody.includes('ã«æ²¿ã£ã¦ç¢ºèª')
              )) ||
              // PRãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
              (prBody.includes('- [x]') && prBody.includes('ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ'))
            );
            
            const needsReminder = !hasChecklistConfirmation && !hasChecklistInPR;
            
            core.setOutput('already_commented', hasReminder);
            core.setOutput('needs_reminder', needsReminder);
            
            if (hasChecklistConfirmation) {
              console.log('âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç¢ºèªå®Œäº†ã®ã‚³ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ');
            } else if (hasChecklistInPR) {
              console.log('âœ… PRæœ¬æ–‡ã«ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç¢ºèªã®è¨˜è¼‰ãŒã‚ã‚Šã¾ã™');
            } else if (hasReminder) {
              console.log('âš ï¸  ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç¢ºèªãŒã¾ã å®Œäº†ã—ã¦ã„ã¾ã›ã‚“ï¼ˆãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼æŠ•ç¨¿æ¸ˆã¿ï¼‰');
            } else {
              console.log('âš ï¸  ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç¢ºèªãŒã¾ã å®Œäº†ã—ã¦ã„ã¾ã›ã‚“ï¼ˆãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’æŠ•ç¨¿ã—ã¾ã™ï¼‰');
            }
      
      - name: Post Checklist Reminder
        if: steps.check_checklist.outputs.needs_reminder == 'true' && steps.check_checklist.outputs.already_commented == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const reminder = [
              '## ğŸ“‹ ã‚»ãƒ«ãƒ•ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼',
              '',
              '@' + context.payload.pull_request.user.login + ' ã•ã‚“',
              '',
              'PRã‚’æŠ•ç¨¿ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼',
              '',
              '**ãƒãƒ¼ã‚¸å‰ã«ã€çµ„ç¹”æ¨™æº–ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’æ­£ã—ãé¸å®šã—ã€ç¢ºèªã—ã¦ã„ã¾ã™ã‹ï¼Ÿ**',
              '',
              '---',
              '',
              '### ğŸ” ç¢ºèªæ‰‹é †',
              '',
              '1. **é©åˆ‡ãªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’é¸å®šã—ã¦ãã ã•ã„**',
              '   - å¤‰æ›´å†…å®¹ã«å¿œã˜ãŸé©åˆ‡ãªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ `devin-organization-standards` ã‹ã‚‰é¸ã‚“ã§ãã ã•ã„',
              '   - è¤‡æ•°ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆãŒè©²å½“ã™ã‚‹å ´åˆã¯ã€ã™ã¹ã¦ç¢ºèªã—ã¦ãã ã•ã„',
              '',
              '2. **ã‚»ãƒ«ãƒ•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„**',
              '   - é¸å®šã—ãŸãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã«æ²¿ã£ã¦ã€ã™ã¹ã¦ã®é …ç›®ã‚’ç¢ºèªã—ã¦ãã ã•ã„',
              '   - ä¸æ˜ãªç‚¹ãŒã‚ã‚Œã°ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã™ã‚‹ã‹è³ªå•ã—ã¦ãã ã•ã„',
              '',
              '3. **ç¢ºèªå®Œäº†ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„**',
              '   - ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç¢ºèªå®Œäº†å¾Œã€ã“ã®PRã«ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„',
              '   - ã©ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨ã—ãŸã‹æ˜è¨˜ã—ã¦ãã ã•ã„',
              '',
              '---',
              '',
              '### ğŸ“š å‚è€ƒè³‡æ–™',
              '',
              '**çµ„ç¹”æ¨™æº–ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: `/devin-organization-standards`',
              '',
              'ä¸»ãªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ:',
              '- [PRãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ](../devin-organization-standards/08-templates/pr-templates/PULL_REQUEST_TEMPLATE.md)',
              '- [ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼åŸºæº–](../devin-organization-standards/03-development-process/code-review-standards.md)',
              '- [ã‚³ãƒ¼ãƒ‰å“è³ªåŸºæº–](../devin-organization-standards/04-quality-standards/code-quality-standards.md)',
              '- [ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„](../devin-organization-standards/01-coding-standards/)',
              '',
              '---',
              '',
              '### âš ï¸ é‡è¦',
              '',
              '- ã“ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã¯**ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç¢ºèªãŒå®Œäº†ã™ã‚‹ã¾ã§**è¡¨ç¤ºã•ã‚Œã¾ã™',
              '- ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç¢ºèªå®Œäº†å¾Œã¯ã€ã‚³ãƒŸãƒƒãƒˆè¿½åŠ æ™‚ã«ã‚‚ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“',
              '- é©åˆ‡ãªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã®é¸å®šã¨ã‚»ãƒ«ãƒ•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯**å¿…é ˆ**ã§ã™',
              '- CIå“è³ªã‚²ãƒ¼ãƒˆãŒã™ã¹ã¦é€šéã™ã‚‹ã¾ã§ã€ã“ã®PRã¯ãƒãƒ¼ã‚¸ã§ãã¾ã›ã‚“',
              '',
              '---',
              '',
              '**AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ–¹ã¸**: ',
              'ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å—ã‘å–ã£ãŸå ´åˆã¯ã€`devin-organization-standards` å†…ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèªã—ã€',
              'ã“ã®PRã®å¤‰æ›´å†…å®¹ã«é©ã—ãŸãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’é¸å®šã—ã¦ã‚»ãƒ«ãƒ•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: reminder
            });
            
            console.log('âœ… ã‚»ãƒ«ãƒ•ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ');
      
      - name: Add Label
        if: steps.check_checklist.outputs.needs_reminder == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['needs-self-review']
            });
            
            console.log('ğŸ·ï¸  ãƒ©ãƒ™ãƒ« "needs-self-review" ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
      
      - name: Remove Label if Confirmed
        if: steps.check_checklist.outputs.needs_reminder == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'needs-self-review'
              });
              console.log('âœ… ãƒ©ãƒ™ãƒ« "needs-self-review" ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            } catch (error) {
              if (error.status === 404) {
                console.log('â„¹ï¸  ãƒ©ãƒ™ãƒ« "needs-self-review" ã¯æ—¢ã«å‰Šé™¤ã•ã‚Œã¦ã„ã¾ã™');
              } else {
                throw error;
              }
            }
