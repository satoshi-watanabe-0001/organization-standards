# PRè¨€èªãƒã‚§ãƒƒã‚¯ï¼ˆæ—¥æœ¬èªå¿…é ˆåŒ–ï¼‰
# 
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€PRã®ã‚¿ã‚¤ãƒˆãƒ«ã¨èª¬æ˜æ–‡ãŒæ—¥æœ¬èªã§è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’è‡ªå‹•æ¤œè¨¼ã—ã¾ã™ã€‚
# æ—¥æœ¬èªãŒå«ã¾ã‚Œã¦ã„ãªã„å ´åˆã€CIã‚’å¤±æ•—ã•ã›ã¦ãƒãƒ¼ã‚¸ã‚’é˜²æ­¢ã—ã¾ã™ã€‚

name: PR Language Check

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  check-pr-language:
    runs-on: ubuntu-latest
    name: æ—¥æœ¬èªè¨˜è¼‰ãƒã‚§ãƒƒã‚¯
    
    steps:
      - name: PRè¨€èªæ¤œè¨¼
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';
            const prTitle = context.payload.pull_request.title || '';
            
            console.log('=== PR Language Check ===');
            console.log('PR Title:', prTitle);
            console.log('PR Body length:', prBody.length);
            
            // æ—¥æœ¬èªæ–‡å­—ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼ˆã²ã‚‰ãŒãªã€ã‚«ã‚¿ã‚«ãƒŠã€æ¼¢å­—ï¼‰
            const japaneseRegex = /[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/;
            
            const hasTitleJapanese = japaneseRegex.test(prTitle);
            const hasBodyJapanese = japaneseRegex.test(prBody);
            
            console.log('Title has Japanese:', hasTitleJapanese);
            console.log('Body has Japanese:', hasBodyJapanese);
            
            // èª¬æ˜æ–‡ãŒç©ºã®å ´åˆã‚‚ã‚¨ãƒ©ãƒ¼
            const hasNoDescription = prBody.trim().length === 0;
            
            if (hasNoDescription) {
              const commentBody = [
                '## âŒ PRè¨€èªãƒã‚§ãƒƒã‚¯å¤±æ•—',
                '',
                '**ã“ã®PRã¯çµ„ç¹”æ¨™æº–ã«æº–æ‹ ã—ã¦ã„ã¾ã›ã‚“ã€‚**',
                '',
                '### ğŸš¨ å•é¡Œç‚¹',
                '- **PRèª¬æ˜æ–‡ãŒç©ºã§ã™**',
                '',
                '### âœ… å¯¾å‡¦æ–¹æ³•',
                '1. **ã€ŒEditã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦èª¬æ˜æ–‡ã‚’è¿½åŠ ã—ã¦ãã ã•ã„**',
                '2. **èª¬æ˜æ–‡ã¯æ—¥æœ¬èªã§è¨˜è¼‰ã—ã¦ãã ã•ã„**',
                '   - å¤‰æ›´å†…å®¹ã®æ¦‚è¦',
                '   - å®Ÿè£…ã—ãŸæ©Ÿèƒ½',
                '   - ãƒ†ã‚¹ãƒˆçµæœ',
                '   - ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã¸ã®è£œè¶³',
                '',
                '### ğŸ“– PRãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‚ç…§',
                '- [PRãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ](.github/PULL_REQUEST_TEMPLATE.md)',
                '- [Phase 4ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¬ã‚¤ãƒ‰](devin-organization-standards/00-guides/phase-guides/phase-4-review-qa-guide.md)',
                '',
                '**ã“ã®CIãƒã‚§ãƒƒã‚¯ãŒé€šéã™ã‚‹ã¾ã§ã€PRã¯ãƒãƒ¼ã‚¸ã§ãã¾ã›ã‚“ã€‚**'
              ].join('\n');
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: commentBody
              });
              
              core.setFailed('âŒ PR description is empty. Please add a description in Japanese.');
              return;
            }
            
            if (!hasTitleJapanese || !hasBodyJapanese) {
              // æ—¥æœ¬èªãŒãªã„å ´åˆã®è©³ç´°åˆ¤å®š
              let missingParts = [];
              if (!hasTitleJapanese) missingParts.push('**ã‚¿ã‚¤ãƒˆãƒ«**');
              if (!hasBodyJapanese) missingParts.push('**èª¬æ˜æ–‡**');
              
              const commentBody = [
                '## âŒ PRè¨€èªãƒã‚§ãƒƒã‚¯å¤±æ•—',
                '',
                '**ã“ã®PRã¯çµ„ç¹”æ¨™æº–ã«æº–æ‹ ã—ã¦ã„ã¾ã›ã‚“ã€‚**',
                '',
                '### ğŸš¨ å•é¡Œç‚¹',
                'ä»¥ä¸‹ã®é …ç›®ãŒæ—¥æœ¬èªã§è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼š',
                ...missingParts.map(part => `- ${part}`),
                '',
                '### âœ… å¯¾å‡¦æ–¹æ³•',
                '',
                '#### ã‚ªãƒ—ã‚·ãƒ§ãƒ³1: ã“ã®PRã‚’ä¿®æ­£ã™ã‚‹ï¼ˆæ¨å¥¨ï¼‰',
                '1. **ã€ŒEditã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯**',
                '2. **ä»¥ä¸‹ã‚’æ—¥æœ¬èªã§è¨˜è¼‰**ï¼š',
                ...((!hasTitleJapanese) ? ['   - ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ—¥æœ¬èªã«å¤‰æ›´'] : []),
                ...((!hasBodyJapanese) ? ['   - èª¬æ˜æ–‡ã‚’æ—¥æœ¬èªã§è¨˜è¼‰'] : []),
                '3. **ä¿å­˜å¾Œã€CIãŒè‡ªå‹•çš„ã«å†æ¤œè¨¼ã•ã‚Œã¾ã™**',
                '',
                '#### ã‚ªãƒ—ã‚·ãƒ§ãƒ³2: PRã‚’å†ä½œæˆã™ã‚‹',
                '1. ã“ã®PRã‚’ã‚¯ãƒ­ãƒ¼ã‚º',
                '2. æ—¥æœ¬èªã§PRã‚’æ–°è¦ä½œæˆ',
                '3. PRãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«å¾“ã£ã¦è¨˜è¼‰',
                '',
                '### ğŸ“ æ—¥æœ¬èªè¨˜è¼‰ã®ä¾‹',
                '',
                '**è‰¯ã„ä¾‹ï¼ˆæ—¥æœ¬èªï¼‰**:',
                '```',
                'ã‚¿ã‚¤ãƒˆãƒ«: ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æ©Ÿèƒ½ã®å®Ÿè£…',
                '',
                'èª¬æ˜æ–‡:',
                '## å¤‰æ›´å†…å®¹',
                '- ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã—ãŸ',
                '- JWTãƒˆãƒ¼ã‚¯ãƒ³ã«ã‚ˆã‚‹èªè¨¼ã‚’è¿½åŠ ã—ã¾ã—ãŸ',
                '- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚’å®Ÿè£…ã—ã¾ã—ãŸ',
                '',
                '## ãƒ†ã‚¹ãƒˆçµæœ',
                '- å˜ä½“ãƒ†ã‚¹ãƒˆ: ã™ã¹ã¦åˆæ ¼',
                '- çµ±åˆãƒ†ã‚¹ãƒˆ: æ­£å¸¸å‹•ä½œã‚’ç¢ºèª',
                '```',
                '',
                '**æ‚ªã„ä¾‹ï¼ˆè‹±èªï¼‰**:',
                '```',
                'Title: Implement user authentication',
                '',
                'Description:',
                '- Implemented login functionality',
                '- Added JWT token authentication',
                '- Implemented user session management',
                '```',
                '',
                '### ğŸ“– é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ',
                '- [PRãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ](.github/PULL_REQUEST_TEMPLATE.md)',
                '- [Phase 4ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¬ã‚¤ãƒ‰](devin-organization-standards/00-guides/phase-guides/phase-4-review-qa-guide.md)',
                '- [PRè¨€èªå•é¡Œã®è§£æ±ºç­–](devin-organization-standards/00-guides/PR-LANGUAGE-ISSUE-SOLUTION.md)',
                '',
                '### ğŸ’¡ ã‚ˆãã‚ã‚‹è³ªå•',
                '',
                '**Q: æŠ€è¡“ç”¨èªï¼ˆAPIã€JWTç­‰ï¼‰ã¯ã©ã†ã™ã‚Œã°ã„ã„ã§ã™ã‹ï¼Ÿ**',
                'A: æŠ€è¡“ç”¨èªã¯è‹±èªã®ã¾ã¾ã§å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚æ–‡ç« å…¨ä½“ãŒæ—¥æœ¬èªã§ã‚ã‚Œã°OKã§ã™ã€‚',
                '',
                '**Q: ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯å†…ã¯ï¼Ÿ**',
                'A: ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯å†…ã¯è‹±èªã§å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚èª¬æ˜æ–‡ãŒæ—¥æœ¬èªã§ã‚ã‚Œã°OKã§ã™ã€‚',
                '',
                '**ã“ã®CIãƒã‚§ãƒƒã‚¯ãŒé€šéã™ã‚‹ã¾ã§ã€PRã¯ãƒãƒ¼ã‚¸ã§ãã¾ã›ã‚“ã€‚**'
              ].join('\n');
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: commentBody
              });
              
              const errorMessage = `âŒ PR must be written in Japanese (æ—¥æœ¬èªå¿…é ˆ). Missing: ${missingParts.join(', ')}`;
              core.setFailed(errorMessage);
              return;
            }
            
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            console.log('âœ… PR language check passed - Japanese detected in both title and body');
            
            const successCommentBody = [
              '## âœ… PRè¨€èªãƒã‚§ãƒƒã‚¯åˆæ ¼',
              '',
              'ã“ã®PRã¯æ—¥æœ¬èªã§æ­£ã—ãè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚',
              '',
              'æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼š',
              '- [ ] ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å®Ÿæ–½',
              '- [ ] CIå“è³ªã‚²ãƒ¼ãƒˆã®é€šéç¢ºèª',
              '- [ ] ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã®æ‰¿èª',
              '',
              'ğŸ“– å‚ç…§: [Phase 4ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¬ã‚¤ãƒ‰](devin-organization-standards/00-guides/phase-guides/phase-4-review-qa-guide.md)'
            ].join('\n');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: successCommentBody
            });
