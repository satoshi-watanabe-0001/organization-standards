---
title: "Phase 3実装ガイド - SQLマイグレーション追加セクション"
version: "1.1.0"
created_date: "2025-11-07"
last_updated: "2025-11-07"
status: "Active"
purpose: "Phase 3実装ガイドにSQLマイグレーションの詳細手順を追加"
---

# Phase 3実装ガイド - SQLマイグレーション追加セクション

> **統合先**: `phase-guides/phase-3-implementation-guide.md`  
> **挿入位置**: Section 3.8（新規セクション）または Section 4.2の後

---

## 3.8 データベースマイグレーション実装（Flyway/Liquibase）

### 目的

データベーススキーマ変更を安全・確実に管理し、組織標準に準拠したドキュメント化されたマイグレーションを作成する。

### 前提条件

- [ ] Phase 2でデータベース設計が完了している
- [ ] マイグレーションツール（Flyway/Liquibase）が設定済み
- [ ] 組織標準`01-coding-standards/sql-standards.md`を確認済み

---

## ステップ3.8.1: マイグレーションファイル作成準備

### チェックポイント

- [ ] マイグレーション命名規則を確認
- [ ] バージョン番号の採番ルールを確認
- [ ] テンプレートを準備

### Flywayファイル命名規則

```
V<バージョン>__<説明>.sql

例:
V1__Create_users_table.sql
V2__Add_user_profiles_table.sql
V3__Create_password_reset_tokens_table.sql
V4__Add_user_indexes.sql
```

**命名ルール**:
- `V`: バージョン管理マイグレーション（必須）
- バージョン番号: 整数、ドット区切り可能（例: `V1`, `V1.1`, `V2.0.1`）
- `__`: アンダースコア2つ（区切り文字）
- 説明: スネークケース、英語、動詞で開始

---

## ステップ3.8.2: SQLファイル作成（テンプレート使用）

### 🎯 重要: 必須コメント規約

**組織標準準拠のため、以下のコメントを必ず記載**:

#### 1. ファイル冒頭コメント（必須）

```sql
/*
 * =============================================================================
 * Migration: V<N> - <マイグレーション名>
 * =============================================================================
 * 
 * 【目的】
 * - マイグレーションの目的を明確に記述
 * - 何を実現するためのマイグレーションか
 * 
 * 【ビジネス背景】
 * - チケット番号: XX-123
 * - ビジネス要件の概要
 * - なぜこの変更が必要か
 * 
 * 【主な設計判断】
 * 1. データ型選択: なぜこのデータ型を選んだか
 * 2. 制約設計: なぜこの制約が必要か
 * 3. インデックス設計: なぜこのインデックスが必要か
 * 4. 正規化判断: 正規化レベルの選択理由
 * 
 * 【想定クエリパターン】（必須）
 * 1. 最頻出クエリ:
 *    SELECT ... WHERE ... ORDER BY ...;
 *    実行頻度: 毎秒1000リクエスト
 * 
 * 2. バッチ処理クエリ:
 *    UPDATE ... WHERE ...;
 *    実行頻度: 日次1回
 * 
 * 3. 分析クエリ:
 *    SELECT ... GROUP BY ... HAVING ...;
 *    実行頻度: 週次レポート
 * 
 * 【インデックス方針】（必須）
 * - インデックス1: <目的>（<想定クエリ>に対応）
 * - インデックス2: <目的>（<想定クエリ>に対応）
 * - 複合インデックス: <カラムの組み合わせ理由>
 * 
 * 【パフォーマンス考慮】
 * - 想定レコード数: 100万件/年
 * - 成長率: 年20%増
 * - インデックスサイズ: 推定50MB
 * 
 * 【セキュリティ考慮事項】（該当する場合）
 * - 個人情報カラム: <カラム名>（暗号化・マスキング方針）
 * - アクセス制御: <権限設定>
 * - 監査ログ: <記録内容>
 * 
 * 【運用・保守】
 * - 定期クリーンアップ: <頻度・対象データ>
 * - モニタリング: <監視項目>
 * - バックアップ: <バックアップ戦略>
 * 
 * 【参照ドキュメント】
 * - 設計書: docs/design/<関連ドキュメント>
 * - API仕様: docs/api/<関連ドキュメント>
 * 
 * 作成日: YYYY-MM-DD
 * 作成者: <チーム名/担当者>
 * レビュー: <レビュアー>
 * =============================================================================
 */
```

#### 2. インデックスコメント（必須）

**各`CREATE INDEX`の前に必ずインラインコメントを記載**:

```sql
-- -----------------------------------------------------------------------------
-- インデックスN: <一言で目的>
-- -----------------------------------------------------------------------------
-- 【目的】
-- - このインデックスの目的
-- 
-- 【想定クエリ】
-- SELECT ... WHERE column_name = ?
-- 
-- 【実行頻度】
-- - 毎秒1000リクエスト
-- 
-- 【パフォーマンス効果】
-- - フルスキャン: 500ms
-- - インデックススキャン: 5ms
-- - 改善率: 100倍
-- 
-- 【設計判断】
-- - なぜこのカラムにインデックスを作成するか
-- - なぜこのインデックスタイプ（B-Tree/Hash/GiST）を選んだか
CREATE INDEX idx_<table>_<column> ON <table>(<column>);

COMMENT ON INDEX idx_<table>_<column> IS 
'<簡潔な目的>
目的: <詳細な目的>
想定クエリ: SELECT ... WHERE <column> = ?
カーディナリティ: <高/中/低>
インデックスタイプ: <B-Tree/Hash/GiST/etc>
推定効果: <具体的な効果>
実行頻度: <頻度>
メンテナンス: <保守に関する注意事項>
レビュー日: YYYY-MM-DD';
```

#### 3. 制約コメント（推奨）

```sql
COMMENT ON CONSTRAINT <constraint_name> ON <table_name> IS 
'<制約の目的>
目的: <なぜこの制約が必要か>
動作: <ON DELETE CASCADE等の動作説明>
理由: <ビジネスロジック的な理由>
注意事項: <運用上の注意点>
例: CASCADE動作により大量削除の可能性あり';
```

#### 4. テーブル・カラムコメント（必須）

```sql
COMMENT ON TABLE <table_name> IS 
'<テーブルの目的>
関連チケット: XX-123
主要機能: <主な機能>
想定レコード数: <初期/将来>
成長率: <年間増加率>';

COMMENT ON COLUMN <table_name>.<column_name> IS 
'<カラムの説明>
形式: <データ形式・例>
用途: <使用目的>
制約: <制約事項>
デフォルト値: <デフォルト値とその理由>';
```

---

## ステップ3.8.3: 完全なSQLマイグレーションテンプレート

### テンプレート: 新規テーブル作成

```sql
/*
 * =============================================================================
 * Migration: V<N> - <テーブル名>テーブル作成
 * =============================================================================
 * 
 * 【目的】
 * - <機能>のための<テーブル名>テーブルを新規作成
 * - <実現する機能>
 * 
 * 【ビジネス背景】
 * - チケット: <XX-123>
 * - 要件: <ビジネス要件>
 * 
 * 【主な設計判断】
 * 1. データ型: <選択理由>
 * 2. 制約: <設計理由>
 * 3. インデックス: <方針>
 * 
 * 【想定クエリパターン】
 * 1. 検索: SELECT ... WHERE ... (頻度: 高)
 * 2. 更新: UPDATE ... WHERE ... (頻度: 中)
 * 3. 削除: DELETE ... WHERE ... (頻度: 低)
 * 
 * 【インデックス方針】
 * - idx_xxx: <目的>
 * - idx_yyy: <目的>
 * 
 * 【セキュリティ】
 * - <考慮事項>
 * 
 * 作成日: YYYY-MM-DD
 * 作成者: <担当者>
 * =============================================================================
 */

-- =============================================================================
-- テーブル作成
-- =============================================================================

CREATE TABLE <table_name> (
    -- プライマリキー
    <id_column> UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ビジネスキー
    <business_key> VARCHAR(255) UNIQUE NOT NULL,
    
    -- データカラム
    <data_column1> VARCHAR(100) NOT NULL,
    <data_column2> INTEGER DEFAULT 0,
    
    -- 外部キー
    <foreign_key> UUID NOT NULL,
    
    -- タイムスタンプ
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
    
    -- 外部キー制約
    CONSTRAINT fk_<table>_<column> 
        FOREIGN KEY (<foreign_key>) 
        REFERENCES <parent_table>(<parent_id>) 
        ON DELETE CASCADE,
    
    -- チェック制約
    CONSTRAINT chk_<name> 
        CHECK (<condition>)
);

-- =============================================================================
-- テーブルコメント
-- =============================================================================

COMMENT ON TABLE <table_name> IS 
'<テーブルの目的>
関連チケット: <XX-123>
想定レコード数: <数>
成長率: <率>';

-- =============================================================================
-- カラムコメント
-- =============================================================================

COMMENT ON COLUMN <table_name>.<id_column> IS 
'プライマリキー（UUID自動生成）
形式: UUID v4
用途: テーブル内部での一意識別子';

COMMENT ON COLUMN <table_name>.<business_key> IS 
'ビジネスキー
形式: <形式>
用途: <用途>
一意性: UNIQUE制約';

-- （全カラムのコメントを記載）

-- =============================================================================
-- インデックス作成
-- =============================================================================

-- -----------------------------------------------------------------------------
-- インデックス1: <目的>
-- -----------------------------------------------------------------------------
-- 目的: <詳細な目的>
-- クエリ: SELECT ... WHERE <column> = ?
-- 頻度: <頻度>
-- 効果: <効果>
CREATE INDEX idx_<table>_<column1> ON <table_name>(<column1>);

COMMENT ON INDEX idx_<table>_<column1> IS 
'<目的>
想定クエリ: WHERE <column1> = ?
インデックスタイプ: B-Tree
推定効果: <効果>
実行頻度: <頻度>';

-- -----------------------------------------------------------------------------
-- インデックス2: <目的>
-- -----------------------------------------------------------------------------
-- （同様に記載）

-- =============================================================================
-- 制約コメント
-- =============================================================================

COMMENT ON CONSTRAINT fk_<table>_<column> ON <table_name> IS 
'外部キー制約
目的: データ整合性維持
削除動作: ON DELETE CASCADE
理由: <ビジネスロジック的理由>
注意: <注意事項>';

COMMENT ON CONSTRAINT chk_<name> ON <table_name> IS 
'チェック制約
目的: <目的>
条件: <condition>
理由: <理由>';
```

---

## ステップ3.8.4: マイグレーション実装チェックリスト

### 作成前チェック

- [ ] `01-coding-standards/sql-standards.md` を確認済み
- [ ] Phase 2設計ドキュメントを確認済み
- [ ] 想定クエリパターンを特定済み
- [ ] インデックス戦略を計画済み

### ファイル冒頭コメント

- [ ] 複数行コメント（`/* ... */`）が存在する
- [ ] 【目的】セクションが記載されている
- [ ] 【ビジネス背景】にチケット番号が記載されている
- [ ] 【主な設計判断】が記載されている
- [ ] 【想定クエリパターン】が3つ以上記載されている
- [ ] 【インデックス方針】が記載されている
- [ ] 【セキュリティ考慮事項】が記載されている（該当する場合）

### テーブル定義

- [ ] SQLキーワードが大文字
- [ ] 識別子が小文字スネークケース
- [ ] 適切にインデントされている
- [ ] 全カラムにNOT NULL/DEFAULT等の制約が明示されている
- [ ] 外部キー制約にON DELETE/ON UPDATE動作が明示されている

### インデックス定義

- [ ] 各`CREATE INDEX`の前にインラインコメントがある
- [ ] インラインコメントに以下が含まれる:
  - [ ] 目的
  - [ ] 想定クエリ
  - [ ] 実行頻度
  - [ ] パフォーマンス効果
  - [ ] 設計判断の理由
- [ ] 各インデックスに`COMMENT ON INDEX`がある
- [ ] `COMMENT ON INDEX`に以下が含まれる:
  - [ ] 簡潔な目的
  - [ ] 想定クエリ（SQL例）
  - [ ] インデックスタイプ
  - [ ] 推定効果
  - [ ] 実行頻度

### 制約コメント

- [ ] 外部キー制約に`COMMENT ON CONSTRAINT`がある（推奨）
- [ ] `ON DELETE CASCADE`の理由が説明されている
- [ ] ビジネスロジック的な意図が記載されている

### テーブル・カラムコメント

- [ ] `COMMENT ON TABLE`がある
- [ ] 関連チケット番号が記載されている
- [ ] 想定レコード数・成長率が記載されている
- [ ] 全カラムに`COMMENT ON COLUMN`がある
- [ ] カラムコメントに形式・用途・制約が記載されている

### テスト

- [ ] ローカル環境でマイグレーション実行確認
- [ ] ロールバック可能性を確認（可能な場合）
- [ ] 想定クエリでパフォーマンステスト実施
- [ ] インデックス効果を`EXPLAIN ANALYZE`で確認

---

## ステップ3.8.5: マイグレーション実行前の確認

### ローカル環境でのテスト

```bash
# Flyway Clean（開発環境のみ）
./mvnw flyway:clean

# Flyway Migrate
./mvnw flyway:migrate

# Flyway Info（適用状況確認）
./mvnw flyway:info

# Flyway Validate（チェックサム検証）
./mvnw flyway:validate
```

### パフォーマンス検証

```sql
-- インデックスなしでの実行計画
EXPLAIN ANALYZE
SELECT ... WHERE ...;

-- インデックスありでの実行計画
EXPLAIN ANALYZE
SELECT ... WHERE ...;

-- インデックス使用状況確認
SELECT 
    schemaname, 
    tablename, 
    indexname, 
    idx_scan, 
    idx_tup_read, 
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE tablename = '<table_name>';
```

---

## ステップ3.8.6: CI/CD統合

### SQLコメント自動チェック設定

**参照**: `00-guides/SQL-MIGRATION-COMMENT-SOLUTION.md`

CI/CDパイプラインに以下を追加:

1. **GitHub Actions ワークフロー**
   - ファイル: `.github/workflows/sql-comment-check.yml`
   - 機能: SQLファイル変更時に自動コメントチェック

2. **チェック項目**:
   - ファイル冒頭コメントの存在
   - 必須キーワード（目的、チケット、クエリ、インデックス）
   - インデックスコメントの網羅性
   - `COMMENT ON INDEX`の存在
   - `COMMENT ON CONSTRAINT`の推奨

3. **エラー時の動作**:
   - PRにコメント自動投稿
   - マージブロック
   - 修正ガイドのリンク提供

---

## ステップ3.8.7: レビュー観点

### レビュアー向けチェックリスト

**コメント品質**:
- [ ] ファイル冒頭コメントが組織標準に準拠している
- [ ] 想定クエリパターンが具体的に記載されている
- [ ] インデックスの必要性が明確に説明されている
- [ ] ビジネス背景とチケット番号が記載されている

**設計品質**:
- [ ] データ型の選択が適切
- [ ] 制約設計が適切（NOT NULL、UNIQUE、CHECK）
- [ ] 外部キー制約のON DELETE/UPDATE動作が適切
- [ ] インデックス設計が想定クエリに対応している

**パフォーマンス**:
- [ ] 不要なインデックスがない
- [ ] 複合インデックスのカラム順序が適切
- [ ] 部分インデックスの活用を検討している

**セキュリティ**:
- [ ] 個人情報カラムの扱いが適切
- [ ] アクセス制御が考慮されている
- [ ] SQLインジェクション対策がされている

---

## トラブルシューティング

### よくある問題

#### 問題1: コメント不足でCIが失敗

**症状**: PR作成後、CI/CDでSQLコメントチェックエラー

**解決策**:
1. `SQL-MIGRATION-COMMENT-SOLUTION.md`を確認
2. テンプレートを使用して修正
3. チェックリストで再確認

#### 問題2: インデックスの効果が見られない

**症状**: インデックスを作成したが、クエリが遅い

**原因**:
- WHERE句のカラム順序がインデックスと異なる
- カーディナリティが低い
- 統計情報が古い

**解決策**:
```sql
-- 統計情報更新
ANALYZE <table_name>;

-- インデックス使用状況確認
EXPLAIN ANALYZE SELECT ... WHERE ...;

-- インデックス再構築（必要に応じて）
REINDEX INDEX idx_<name>;
```

#### 問題3: マイグレーション失敗（既存データと競合）

**症状**: NOT NULL制約追加時にエラー

**解決策**:
```sql
-- ステップ1: デフォルト値付きでカラム追加
ALTER TABLE <table_name> 
ADD COLUMN <column_name> VARCHAR(100) DEFAULT 'default_value';

-- ステップ2: 既存データを更新
UPDATE <table_name> 
SET <column_name> = <適切な値> 
WHERE <column_name> IS NULL;

-- ステップ3: NOT NULL制約を追加
ALTER TABLE <table_name> 
ALTER COLUMN <column_name> SET NOT NULL;
```

---

## 参考リソース

### 内部ドキュメント

- **SQL標準**: `01-coding-standards/sql-standards.md`
- **解決策ガイド**: `00-guides/SQL-MIGRATION-COMMENT-SOLUTION.md`
- **CI設定**: `00-guides/CI-SETUP-CHECKLIST.md`
- **Phase 2設計**: `phase-guides/phase-2-design-guide.md`

### テンプレート

- **マイグレーションテンプレート**: `08-templates/sql-migration-template.sql`（要作成）
- **コメントテンプレート**: `08-templates/code-templates/sql/`（要作成）

### 外部リソース

- [Flyway公式ドキュメント](https://flywaydb.org/documentation/)
- [PostgreSQL COMMENT構文](https://www.postgresql.org/docs/current/sql-comment.html)
- [PostgreSQL インデックス](https://www.postgresql.org/docs/current/indexes.html)

---

## まとめ

### Phase 3でのSQLマイグレーション実装の要点

1. ✅ **テンプレート使用**: 必ず組織標準テンプレートを使用
2. ✅ **詳細コメント**: Why重視のコメント（目的、理由、効果）
3. ✅ **想定クエリ記載**: 最低3パターンの想定クエリを記載
4. ✅ **インデックス説明**: 各インデックスの必要性を明確に説明
5. ✅ **CI/CD統合**: 自動チェックで品質担保
6. ✅ **レビュー実施**: チェックリストに基づく徹底レビュー

### 次のステップ

- [ ] Phase 4: レビュー・QA（SQLコメント品質確認）
- [ ] CI/CD: 自動チェック結果確認
- [ ] ドキュメント更新: マイグレーション実施記録

---

**統合日**: 2025-11-07  
**対象ドキュメント**: `phase-guides/phase-3-implementation-guide.md`  
**セクション**: 3.8（新規）
