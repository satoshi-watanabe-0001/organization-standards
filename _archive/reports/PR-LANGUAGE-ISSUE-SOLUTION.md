# PR言語問題の解決策（日本語必須化）

## 📋 目次
- [1. 問題の概要](#1-問題の概要)
- [2. 根本原因分析](#2-根本原因分析)
- [3. 解決策](#3-解決策)
- [4. 実装内容](#4-実装内容)
- [5. 運用フロー](#5-運用フロー)
- [6. FAQ](#6-faq)

---

## 1. 問題の概要

### 1.1 発生状況
- **作業内容**: Devinを使用したコード生成およびPR作成
- **使用した機能**: PR作成機能、コメント機能
- **環境**: 全プロジェクト共通

### 1.2 期待される動作
PRの説明文やbotのコメントが日本語で記載され、チームメンバーが即座に内容を理解できる。

### 1.3 実際の動作
PRの説明文やbotのコメントが英語で記載されるため、英語に不慣れなメンバーは内容の理解に時間がかかる。

### 1.4 再現手順
1. Devinに任意のタスクを依頼
2. Devinがコードを生成しPRを作成
3. PRの説明文やコメントを確認
4. 英語で記載されていることを確認

### 1.5 影響範囲
- **影響を受けるチーム**: 全開発チーム
- **影響度**: 高（コミュニケーション効率の低下）
- **頻度**: 毎回（Devin使用時）

---

## 2. 根本原因分析

### 2.1 直接原因
Devin（AI）がデフォルトで英語でPRを作成してしまう。

### 2.2 根本原因
1. **ガイドライン不足**: PR作成時の言語要件が明確に定義されていない
2. **テンプレート欠如**: 日本語でのPRテンプレートが存在しない
3. **品質ゲート不足**: 言語チェックの自動化がされていない
4. **プロセス整備不足**: Phase別ガイドでPR言語要件が言及されていない

### 2.3 類似問題との関連
- **CI設定漏れ問題**: ガイドライン参照の欠如、品質ゲート不足
- **ドキュメントコメント漏れ問題**: テンプレート不足、品質ゲート不足

**共通パターン**: 組織標準が明確でなく、自動検証もない状態

---

## 3. 解決策

### 3.1 多層防御アプローチ

本問題は、**3つのレイヤー**で対策を実施します：

#### **Level 1: 事前予防**
PRテンプレート整備でDevinに日本語記載を促す

#### **Level 2: 自動検出・強制**（最も効果的）
CI品質ゲートで日本語以外のPRを自動的に却下

#### **Level 3: プロセス整備**
ガイドライン・チェックリストでの必須化

---

### 3.2 解決策一覧

| 解決策 | 効果 | 実装コスト | 強制力 | 優先度 |
|--------|------|-----------|--------|--------|
| **CI品質ゲート** | ★★★★★ | 中 | **強制** | 🔴 最優先 |
| **PRテンプレート** | ★★★★☆ | 低 | 誘導 | 🟡 高優先 |
| **Phase 4ガイド更新** | ★★★☆☆ | 低 | 誘導 | 🟢 中優先 |
| **AI-PRE-WORK-CHECKLIST更新** | ★★★☆☆ | 低 | 誘導 | 🟢 中優先 |
| **コーディング規約追加** | ★★☆☆☆ | 低 | 誘導 | 🟢 中優先 |

---

## 4. 実装内容

### 4.1 Level 2: CI品質ゲート（最優先）

#### 4.1.1 実装ファイル
`.github/workflows/pr-language-check.yaml`

#### 4.1.2 仕組み
GitHub Actions/GitLab CIでPR説明文の言語を自動検出し、**日本語以外の場合はCIを失敗**させます。

#### 4.1.3 検証ロジック
```javascript
// 日本語文字（ひらがな、カタカナ、漢字）の存在チェック
const japaneseRegex = /[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/;

const hasTitleJapanese = japaneseRegex.test(prTitle);
const hasBodyJapanese = japaneseRegex.test(prBody);

if (!hasTitleJapanese || !hasBodyJapanese) {
  // CI失敗 + botコメント
}
```

#### 4.1.4 検証項目
- ✅ PRタイトルに日本語文字が含まれているか
- ✅ PR説明文に日本語文字が含まれているか
- ✅ PR説明文が空でないか

#### 4.1.5 CI失敗時のアクション
1. **自動botコメント**を投稿
   - 問題点の明示
   - 対処方法の提示（2つのオプション）
   - 良い例・悪い例の提示
   - 関連ドキュメントのリンク
2. **CI失敗**（ステータス: ❌）
3. **マージ不可**（CI通過が必須のため）

#### 4.1.6 効果
- ✅ **英語PRは自動的にCI失敗** → マージ不可
- ✅ **botが日本語での再作成を指示** → 手動対応不要
- ✅ **強制力が最も高い** → 確実に日本語PR化

---

### 4.2 Level 1: PRテンプレート（高優先）

#### 4.2.1 実装ファイル
`.github/PULL_REQUEST_TEMPLATE.md`

#### 4.2.2 配置場所
```
プロジェクトルート/
├── .github/
│   ├── PULL_REQUEST_TEMPLATE.md          # デフォルトテンプレート
│   └── workflows/
│       └── pr-language-check.yaml
```

または、組織標準テンプレート集として：
```
/08-templates/pr-templates/
├── PULL_REQUEST_TEMPLATE.md          # デフォルトテンプレート
├── PULL_REQUEST_TEMPLATE_FEATURE.md  # 機能追加用
├── PULL_REQUEST_TEMPLATE_BUGFIX.md   # バグ修正用
└── README.md                          # テンプレート使用ガイド
```

#### 4.2.3 テンプレート構成
1. **重要事項**（日本語必須の明記）
2. **変更内容の概要**（必須）
3. **関連チケット**
4. **変更の詳細**（機能追加/バグ修正/リファクタリング）
5. **テストの実施状況**
6. **スクリーンショット**（該当する場合）
7. **レビュアーへの補足**
8. **セキュリティチェック**
9. **パフォーマンスへの影響**
10. **ドキュメント更新**
11. **組織標準チェックリスト**（言語チェック含む）
12. **関連ドキュメント**
13. **良い例・悪い例**

#### 4.2.4 効果
- ✅ Devinがテンプレートに従って**日本語でPRを作成**
- ✅ チェックリスト形式で**言語確認を強制**
- ✅ **即効性が高い**（すぐに導入可能）

---

### 4.3 Level 3: プロセス整備（中優先）

#### 4.3.1 Phase 4レビューガイド更新

**追加セクション**: `4.1.X PR説明文・言語チェック`

```markdown
### 4.1.X PR説明文・言語チェック ⭐NEW

**重要**: PRの説明文とタイトルは**日本語で記載することが必須**です。

#### チェック項目
- [ ] PRタイトルが日本語で記載されている
- [ ] PR説明文が日本語で記載されている
- [ ] 変更内容の概要が日本語で明確に記載されている
- [ ] テスト結果が日本語で記載されている
- [ ] レビュアーへの補足が日本語で記載されている

#### 英語記載の場合の対応
1. **PRをクローズ**
2. **日本語でPRを再作成**
3. CI品質ゲートが自動検証

#### 例外
- 技術用語（API、OAuth、JWT等）は英語可
- コードブロック内のコメントは英語可

📖 **参照**: 
- [PRテンプレート](.github/PULL_REQUEST_TEMPLATE.md)
- [PR言語問題の解決策](../00-guides/PR-LANGUAGE-ISSUE-SOLUTION.md)
```

#### 4.3.2 AI-PRE-WORK-CHECKLIST更新

**Phase 4セクションに追加**:

```markdown
### Phase 4: レビュー・QA

**追加確認事項**:
- [ ] **PR作成時の言語要件を確認したか** ⭐NEW
  - 📖 参照: [PRテンプレート](../08-templates/pr-templates/PULL_REQUEST_TEMPLATE.md)
  - 📖 詳細: [PR言語問題の解決策](./PR-LANGUAGE-ISSUE-SOLUTION.md)
  - PRタイトル・説明文は日本語必須
  - CI品質ゲートで自動検証される
  - 英語記載の場合はPR再作成が必要
```

#### 4.3.3 コーディング規約に言語規約追加

**新規セクション**: `PR・コメント言語規約`

```markdown
## PR・コメント言語規約 ⭐NEW

### 必須言語
- **日本語**: PRタイトル、PR説明文、PRコメント、レビューコメント
- **英語**: コード、変数名、関数名、コミットメッセージ（推奨）

### 品質ゲート
- CI品質ゲートで日本語記載を自動検証
- 英語記載のPRはCI失敗（マージ不可）
- 自動botコメントで修正方法を通知

### 例外
- **技術用語**: API、OAuth、JWT、HTTP、REST、GraphQL等は英語可
- **コードブロック内**: コメントは英語可
- **固有名詞**: GitHub、Docker、Kubernetes等は英語可

### 良い例
```markdown
タイトル: JWT認証機能の実装

## 変更内容
RESTful APIにJWT（JSON Web Token）認証を実装しました。
OAuth 2.0プロトコルに準拠し、セキュアなトークン管理を実現しています。

## テスト結果
- 単体テストカバレッジ: 95%
- セキュリティテスト: 脆弱性なし
```

### 悪い例
```markdown
Title: Implement JWT authentication

## Changes
Implemented JWT authentication for RESTful API.
```

### 理由
- 日本語チームでのコミュニケーション効率向上
- レビュー時の理解速度向上
- ドキュメント検索性の向上
```

---

## 5. 運用フロー

### 5.1 正常フロー（日本語PR）

```
1. Devin/開発者がPR作成
   ↓
2. PRテンプレートに従って日本語で記載
   ↓
3. PR作成 (タイトル・説明文が日本語)
   ↓
4. CI品質ゲート実行
   ↓
5. 言語チェック: ✅ 合格
   ↓
6. 自動botコメント: "✅ PR言語チェック合格"
   ↓
7. 他のCI品質ゲート実行
   ↓
8. コードレビュー
   ↓
9. 承認・マージ
```

### 5.2 異常フロー（英語PR）

```
1. Devin/開発者がPR作成
   ↓
2. 英語でPR記載（タイトルまたは説明文）
   ↓
3. PR作成
   ↓
4. CI品質ゲート実行
   ↓
5. 言語チェック: ❌ 失敗
   ↓
6. 自動botコメント投稿
   - 問題点の明示
   - 対処方法の提示
   - 良い例・悪い例
   - 関連ドキュメント
   ↓
7. CI失敗（マージ不可）
   ↓
8. 対処方法の選択

   【オプション1: PR修正（推奨）】
   - 「Edit」ボタンクリック
   - タイトル・説明文を日本語に修正
   - 保存
   - CI自動再実行
   - ✅ 合格 → コードレビューへ

   【オプション2: PR再作成】
   - PRクローズ
   - 日本語で新規PR作成
   - ✅ 合格 → コードレビューへ
```

### 5.3 例外フロー（技術用語を含む日本語PR）

```
1. PR作成（日本語 + 技術用語）
   例: "JWT認証機能の実装"
   ↓
2. CI品質ゲート実行
   ↓
3. 言語チェック: ✅ 合格
   （日本語文字が検出されればOK）
   ↓
4. コードレビュー
```

---

## 6. FAQ

### 6.1 一般的な質問

#### Q1: 技術用語（API、JWT、OAuth等）はどうすればいいですか？
**A**: 技術用語は英語のままで問題ありません。文章全体が日本語であればOKです。

**例（OK）**:
```markdown
タイトル: RESTful APIの実装

JWT（JSON Web Token）を使用したOAuth 2.0認証を実装しました。
```

#### Q2: コードブロック内のコメントは？
**A**: コードブロック内は英語で問題ありません。PR説明文が日本語であればOKです。

**例（OK）**:
```markdown
## 変更内容
ログイン機能を実装しました。

\```java
// Login endpoint implementation
@PostMapping("/api/auth/login")
public ResponseEntity<LoginResponse> login() {
    // ...
}
\```
```

#### Q3: 英語PRを修正するのと、再作成するのと、どちらがいいですか？
**A**: **PR修正（オプション1）を推奨**します。理由：
- コミット履歴が保持される
- レビューコメントが保持される
- PR番号が変わらない
- 簡単で速い

#### Q4: このCI品質ゲートを無効化できますか？
**A**: 組織標準として必須です。無効化はできません。

#### Q5: 日本語でPRを書くのに時間がかかります...
**A**: PRテンプレートを活用してください。テンプレートに従って記入するだけで、標準的なPRが作成できます。

---

### 6.2 Devin（AI）関連の質問

#### Q6: Devinに日本語でPRを作成させるには？
**A**: 以下の方法があります：

1. **PRテンプレートを配置**（最も効果的）
   - `.github/PULL_REQUEST_TEMPLATE.md` を配置
   - Devinが自動的にテンプレートに従う

2. **タスク指示時に明示**
   ```
   【タスク】ユーザー認証機能を実装してください。

   【重要】
   - PRの説明文は日本語で記載してください
   - PRテンプレートに従ってください
   ```

3. **組織標準ドキュメントの参照**
   ```
   【参照】
   - Phase 3実装ガイド
   - Phase 4レビューガイド
   - PRテンプレート
   ```

#### Q7: Devinが英語でPRを作成してしまったら？
**A**: CI品質ゲートが自動的に検出して、修正方法を提示します。botコメントの指示に従ってください。

#### Q8: Devinに日本語コメントを書かせるには？
**A**: Devinの設定で言語を日本語に設定するか、タスク指示時に明示してください。

---

### 6.3 技術的な質問

#### Q9: 言語検出の正規表現は何を使っていますか？
**A**: 日本語文字（ひらがな、カタカナ、漢字）を検出する正規表現：
```javascript
/[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/
```

#### Q10: CI品質ゲートの実装はどこにありますか？
**A**: `.github/workflows/pr-language-check.yaml` に実装されています。

#### Q11: PR説明文が空の場合はどうなりますか？
**A**: CI失敗します。説明文の記載が必須です。

#### Q12: GitLabでも使えますか？
**A**: はい。GitLab CIに移植可能です。ロジックは同じで、CI設定ファイルの構文のみ異なります。

---

## 7. 関連ドキュメント

### 7.1 組織標準
- [Phase 4レビューガイド](./phase-guides/phase-4-review-qa-guide.md)
- [AI-PRE-WORK-CHECKLIST](./AI-PRE-WORK-CHECKLIST.md)
- [コーディング規約](../01-coding-standards/)

### 7.2 テンプレート
- [PRテンプレート](../08-templates/pr-templates/PULL_REQUEST_TEMPLATE.md)
- [PRテンプレート使用ガイド](../08-templates/pr-templates/README.md)

### 7.3 CI設定
- [CI設定チェックリスト](./CI-SETUP-CHECKLIST.md)
- [CI品質ゲート設定ガイド](../03-development-process/ci-cd-pipeline.md)

---

## 8. 更新履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|---------|--------|
| 2025-11-07 | 1.0.0 | 初版作成 | Organization Standards Team |

---

**このドキュメントは組織標準の一部です。フィードバックや改善提案は Issue で受け付けています。**
